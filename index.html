<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜Ÿç•Œå‚³èªªï¼šå‘½é‹ä¹‹æˆ° v3.5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #0f111a; color: #e2e8f0; overflow-x: hidden; perspective: 1000px; user-select: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.2); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #718096; }

        .card-R { border: 2px solid #718096; background: linear-gradient(145deg, #2d3748, #1a202c); }
        .card-SR { border: 2px solid #805ad5; background: linear-gradient(145deg, #44337a, #2d3748); box-shadow: 0 0 10px rgba(128, 90, 213, 0.3); }
        .card-SSR { border: 2px solid #ecc94b; background: linear-gradient(145deg, #744210, #2d3748); box-shadow: 0 0 15px rgba(236, 201, 75, 0.5); animation: shimmer 3s infinite linear; }
        @keyframes shimmer { 0% { border-color: #ecc94b; } 50% { border-color: #f6e05e; } 100% { border-color: #ecc94b; } }
        
        /* Gacha Pop-in Animation */
        @keyframes pop-in { 
            0% { transform: scale(0); opacity: 0; } 
            60% { transform: scale(1.1); opacity: 1; } 
            100% { transform: scale(1); opacity: 1; } 
        }
        
        .text-SSR { color: #f6ad55; text-shadow: 0 0 5px #d69e2e; } .text-SR { color: #d6bcfa; text-shadow: 0 0 5px #805ad5; } .text-R { color: #cbd5e0; }
        .equip-slot { width: 50px; height: 50px; background: rgba(0,0,0,0.5); border: 1px dashed #4a5568; border-radius: 8px; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: all 0.2s; }
        .equip-slot:hover { border-color: #fbbf24; background: rgba(251, 191, 36, 0.1); }
        .equip-filled { border-style: solid; border-color: #718096; background: #2d3748; }
        .equip-filled.rare-SR { border-color: #805ad5; } .equip-filled.rare-SSR { border-color: #ecc94b; }

        /* Updated Battle Unit Sizing for 5v5 */
        .battle-unit { width: 16vw; max-width: 75px; min-width: 45px; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; position: relative; z-index: 10; margin: 0 1px; transition: transform 0.2s; filter: brightness(0.7); }
        .battle-unit.active-turn { filter: brightness(1.2); z-index: 20; }
        
        .battle-hp-container { width: 100%; height: 6px; background: #2d3748; border: 1px solid #1a202c; border-radius: 4px; overflow: hidden; margin-bottom: 2px; position: relative; z-index: 20; }
        .hp-bar-transition { transition: width 0.3s ease-out; }
        .battle-status-container { 
            position: absolute; 
            bottom: 100%; 
            left: 0; 
            width: 100%; 
            display: flex; 
            justify-content: center; 
            flex-wrap: wrap; 
            gap: 1px; 
            z-index: 30; 
            pointer-events: none; 
            margin-bottom: 2px;
        }
        .status-icon { font-size: 8px; width: 14px; height: 14px; background: rgba(0,0,0,0.8); border-radius: 3px; display: flex; align-items: center; justify-content: center; color: white; border: 1px solid rgba(255,255,255,0.2); animation: bounce 1s infinite; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .status-buff { border-color: #48bb78; color: #48bb78; } .status-debuff { border-color: #f56565; color: #f56565; } .status-ctrl { border-color: #ecc94b; color: #ecc94b; }
        .status-taunt { border-color: #ed8936; color: #ed8936; box-shadow: 0 0 5px #ed8936; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

        .battle-card-wrapper { width: 100%; aspect-ratio: 3/4; position: relative; z-index: 10; }
        .battle-avatar { width: 100%; height: 100%; border-radius: 8px; background: rgba(20, 20, 30, 0.8); border: 2px solid #4a5568; overflow: hidden; position: relative; transition: all 0.3s; }
        .battle-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .battle-unit.active-turn .battle-avatar { border-color: #ecc94b; transform: scale(1.1) translateY(-5px); box-shadow: 0 0 15px #ecc94b; z-index: 20; }
        .active-indicator { position: absolute; top: -25px; color: #ecc94b; font-size: 1.2rem; animation: bounce 1s infinite; z-index: 40; text-shadow: 0 0 5px black; font-weight: bold; width: 100%; text-align: center; }

        .element-badge { position: absolute; top: 2px; right: 2px; width: 14px; height: 14px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 8px; z-index: 25; border: 1px solid white; box-shadow: 0 0 5px black; }
        .ele-fire { background: #e53e3e; } .ele-water { background: #3182ce; } .ele-wind { background: #38a169; }
        .ele-earth { background: #d69e2e; } .ele-light { background: #f6e05e; color: #000; } .ele-dark { background: #4a5568; }

        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        .damage-text, .heal-text, .skill-text { position: fixed; font-weight: 900; font-size: 1.5rem; animation: floatUp 0.8s forwards; pointer-events: none; z-index: 100; text-shadow: 2px 2px 0 #000; }
        .damage-text { color: #fc8181; } .heal-text { color: #68d391; } .skill-text { color: #fbbf24; font-size: 1.2rem; }
        @keyframes floatUp { 0% { transform: translate(-50%, 0); opacity: 0; } 20% { transform: translate(-50%, -20px); opacity: 1; } 100% { transform: translate(-50%, -80px); opacity: 0; } }

        /* VFX */
        .vfx-slash { position: absolute; top: -50px; left: -50px; width: 100px; height: 100px; border-top: 4px solid white; border-radius: 50%; animation: slash 0.3s ease-out forwards; z-index: 50; }
        @keyframes slash { 0% { transform: scale(0.5) rotate(-45deg); opacity: 0; } 50% { opacity: 1; } 100% { transform: scale(2.0) rotate(-45deg) translate(20px, 20px); opacity: 0; } }
        .vfx-burst-ring { position: absolute; top: -40px; left: -40px; width: 80px; height: 80px; border-radius: 50%; border: 2px solid; animation: burst 0.5s ease-out forwards; z-index: 45; }
        @keyframes burst { 0% { transform: scale(0); opacity: 1; } 100% { transform: scale(2); opacity: 0; border-width: 0; } }
        .vfx-particle { position: absolute; width: 6px; height: 6px; border-radius: 50%; pointer-events: none; z-index: 45; animation: particle-fly 0.6s ease-out forwards; }
        @keyframes particle-fly { 0% { transform: translate(0, 0) scale(1); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; } }

        /* Ultimate Cut-in */
        #ultimate-cutin { perspective: 1000px; }
        .cutin-bg-animate { animation: burst-bg 0.8s ease-out forwards; } 
        @keyframes burst-bg { 0% { opacity: 0; transform: scale(1); } 10% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0; transform: scale(1.5); } }
        .cutin-char-animate { animation: slide-char 0.6s forwards; } 
        @keyframes slide-char { 0% { transform: translateX(-100%) scale(0.8); opacity: 0; } 10% { opacity: 1; } 100% { transform: translateX(0) scale(1); opacity: 1; } }
        .cutin-icon-animate { animation: slide-icon 0.6s forwards; } 
        @keyframes slide-icon { 0% { transform: translateX(100%) skewX(-12deg); opacity: 0; } 50% { opacity: 0.1; } 100% { transform: translateX(0) skewX(-12deg); opacity: 0.2; } }

        .lobby-bg-pattern { background-color: #0f111a; background-image: linear-gradient(to bottom, rgba(15, 17, 26, 0.2), rgba(15, 17, 26, 0.95)), url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?q=80&w=2000&auto=format&fit=crop'); background-size: cover; background-position: center; }
        .star-glow { animation: star-pulse 3s infinite ease-in-out; }
        @keyframes star-pulse { 0%, 100% { transform: scale(1); opacity: 0.8; filter: drop-shadow(0 0 10px white); } 50% { transform: scale(1.3); opacity: 1; filter: drop-shadow(0 0 25px cyan); } }
        
        /* Summon Anim */
        #ssr-summon-animation { perspective: 1000px; overflow: hidden; }
        .summon-core { width: 20px; height: 20px; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 50px 20px white; z-index: 50; }
        .anim-SSR .summon-core { animation: core-pulse-SSR 3s forwards; background: white; }
        @keyframes core-pulse-SSR { 0% { transform: translate(-50%, -50%) scale(1); } 80% { transform: translate(-50%, -50%) scale(0.1); } 100% { transform: translate(-50%, -50%) scale(100); opacity: 0; } }
        .screen-flash { position: absolute; inset: 0; background-color: white; z-index: 100; animation: flash-white 0.5s ease-out forwards; pointer-events: none; }
        @keyframes flash-white { 0% { opacity: 1; } 100% { opacity: 0; } }
    </style>
</head>
<body class="h-screen h-[100dvh] flex flex-col items-center justify-center bg-gray-900 select-none" onclick="SoundManager.init()">

    <!-- Overlays -->
    <div id="ultimate-cutin" class="hidden fixed inset-0 z-[60] flex items-center justify-center overflow-hidden pointer-events-none">
        <div id="cutin-bg" class="absolute inset-0 bg-gradient-to-r from-black to-gray-900 opacity-90"></div>
        <div class="absolute bottom-0 left-[-50px] md:left-20 h-[120%] w-[80%] flex items-end filter drop-shadow-2xl z-20">
             <img id="cutin-img" src="" class="h-full object-contain transform scale-110 origin-bottom-left rounded-[3rem] border-2 border-white/10" style="filter: drop-shadow(0 0 20px rgba(255,255,255,0.3));">
        </div>
        <div class="absolute bottom-1/3 right-0 w-full bg-black bg-opacity-50 py-4 transform skew-x-12 origin-bottom-right z-30">
             <div id="cutin-text" class="text-white font-black text-6xl italic text-right pr-10 md:pr-32 transform -skew-x-12" style="text-shadow: 4px 4px 0 #000, 0 0 20px rgba(255,215,0,0.8);"></div>
             <div id="cutin-class-icon" class="absolute -top-16 right-10 text-9xl text-white opacity-20 transform -skew-x-12"></div>
        </div>
    </div>
    
    <div id="ssr-summon-animation" class="hidden fixed inset-0 z-[70] bg-black flex flex-col items-center justify-center pointer-events-none">
        <div class="summon-core"></div><div id="summon-flash" class="screen-flash hidden"></div>
    </div>

    <!-- Equip Select -->
    <div id="equip-select-overlay" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-95 backdrop-blur-md p-4">
        <div class="w-full max-w-md h-[80vh] bg-gray-900 border border-gray-700 rounded-2xl flex flex-col relative">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center"><h3 class="text-xl font-bold text-white">é¸æ“‡è£å‚™</h3><button onclick="closeEquipSelect()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button></div>
            <div id="equip-list-container" class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar"></div>
        </div>
    </div>

    <!-- Settings Overlay -->
    <div id="settings-overlay" class="hidden fixed inset-0 z-[80] flex items-center justify-center bg-black bg-opacity-90 backdrop-blur-md p-4">
        <div class="bg-gray-800 border border-gray-600 rounded-2xl w-full max-w-lg p-6 relative shadow-2xl flex flex-col gap-4">
            <div class="flex justify-between items-center border-b border-gray-700 pb-2">
                <h2 class="text-2xl font-bold text-white">ç³»çµ±è¨­å®š</h2>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-white"><i class="fas fa-times text-2xl"></i></button>
            </div>
            
            <div class="space-y-4">
                <div class="bg-gray-900 p-4 rounded-xl border border-gray-700">
                    <h3 class="text-lg font-bold text-yellow-400 mb-2"><i class="fas fa-save mr-2"></i>è³‡æ–™å‚™ä»½ / å¼•ç¹¼</h3>
                    <p class="text-xs text-gray-400 mb-4">æ‚¨å¯ä»¥å°‡å­˜æª”åŒ¯å‡ºæˆä»£ç¢¼ï¼Œåœ¨å…¶ä»–è£ç½®åŒ¯å…¥ä»¥æ¢å¾©é€²åº¦ã€‚</p>
                    
                    <div class="flex gap-2 mb-4">
                        <button onclick="exportSave()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2 rounded font-bold transition"><i class="fas fa-file-export mr-2"></i>åŒ¯å‡ºå­˜æª”</button>
                        <button onclick="importSave()" class="flex-1 bg-green-600 hover:bg-green-500 text-white py-2 rounded font-bold transition"><i class="fas fa-file-import mr-2"></i>åŒ¯å…¥å­˜æª”</button>
                    </div>
                    
                    <div class="bg-gray-950 p-2 rounded border border-gray-800 hidden" id="export-area">
                        <div class="text-xs text-gray-500 mb-1">è«‹è¤‡è£½ä»¥ä¸‹ä»£ç¢¼ï¼š</div>
                        <textarea id="save-code-output" class="w-full h-24 bg-gray-900 text-green-400 text-xs p-2 rounded border border-gray-700 break-all resize-none" readonly></textarea>
                        <button onclick="copySaveCode()" class="w-full mt-2 bg-gray-700 hover:bg-gray-600 text-white text-xs py-1 rounded">è¤‡è£½åˆ°å‰ªè²¼ç°¿</button>
                    </div>
                </div>

                <div class="bg-red-900/20 p-4 rounded-xl border border-red-900/50">
                    <h3 class="text-lg font-bold text-red-400 mb-2"><i class="fas fa-exclamation-triangle mr-2"></i>å±éšªå€åŸŸ</h3>
                    <button onclick="resetData()" class="w-full bg-red-800 hover:bg-red-700 text-white py-2 rounded font-bold transition"><i class="fas fa-trash-alt mr-2"></i>æ¸…é™¤æ‰€æœ‰è³‡æ–™ (é‡ç½®)</button>
                </div>
            </div>
            
            <div class="text-center text-xs text-gray-600 mt-2">
                Game Version 3.5 (Speed Battle)
            </div>
        </div>
    </div>

    <!-- Char Detail -->
    <div id="char-detail-overlay" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-90 backdrop-blur-md p-4">
        <div class="bg-gray-800 border border-gray-600 rounded-2xl w-full max-w-xl p-6 relative shadow-2xl flex flex-col gap-4 overflow-y-auto max-h-[85vh] custom-scrollbar">
            <button onclick="closeCharDetail()" class="absolute top-4 right-4 text-gray-400 hover:text-white z-10"><i class="fas fa-times text-2xl"></i></button>
            <div class="flex gap-4 relative">
                <div id="detail-img-container" class="w-24 h-32 rounded-xl overflow-hidden border-2 border-gray-600 shrink-0 bg-gray-900 flex items-center justify-center"><img id="detail-img" src="" class="w-full h-full object-cover object-top"></div>
                <div class="flex-1">
                    <h2 id="detail-name" class="text-2xl font-bold text-white mb-1">Character</h2>
                    <div id="detail-rarity" class="text-sm font-bold mb-2">SSR</div>
                    <div class="flex flex-col gap-2">
                        <div class="flex gap-2 text-xs text-gray-300">
                             <span id="detail-class" class="bg-gray-700 px-2 py-1 rounded border border-gray-600">Class</span>
                        </div>
                        <div id="detail-elements" class="flex gap-2 text-xs"></div>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-3 gap-2 bg-gray-900 p-3 rounded-lg">
                <div class="text-center"><div class="text-xs text-gray-500">HP</div><div id="detail-hp" class="text-lg font-bold text-green-400">1000</div></div>
                <div class="text-center"><div class="text-xs text-gray-500">ATK</div><div id="detail-atk" class="text-lg font-bold text-red-400">150</div></div>
                <div class="text-center"><div class="text-xs text-gray-500">SPD</div><div id="detail-spd" class="text-lg font-bold text-cyan-400">100</div></div>
            </div>

            <!-- Passive Section -->
            <div id="detail-passive-section" class="bg-indigo-900/30 p-3 rounded-xl border border-indigo-700/50">
                <h4 class="text-xs font-bold text-indigo-400 mb-2 uppercase tracking-widest flex items-center gap-2"><i class="fas fa-seedling"></i> è¢«å‹•æŠ€èƒ½</h4>
                <div id="detail-passive-info" class="text-sm"></div>
            </div>

            <!-- Skills Section -->
            <div id="detail-skills-section" class="bg-gray-900/50 p-3 rounded-xl border border-gray-700">
                <h4 class="text-xs font-bold text-gray-500 mb-2 uppercase tracking-widest flex items-center gap-2"><i class="fas fa-bolt"></i> æŠ€èƒ½è©³æƒ…</h4>
                <div id="detail-skills-list" class="space-y-2"></div>
            </div>

            <div id="detail-equip-section" class="flex justify-between items-center bg-gray-900/50 p-3 rounded-xl border border-gray-700">
                <div class="equip-slot" id="slot-weapon" onclick="openEquipSelect('weapon')"><i class="fas fa-plus text-gray-500"></i></div>
                <div class="equip-slot" id="slot-armor" onclick="openEquipSelect('armor')"><i class="fas fa-plus text-gray-500"></i></div>
                <div class="equip-slot" id="slot-accessory" onclick="openEquipSelect('accessory')"><i class="fas fa-plus text-gray-500"></i></div>
                <div class="text-xs text-gray-500 ml-2 flex-1 text-right">é»æ“Šæ’æ§½æ›´æ›è£å‚™</div>
            </div>
            
            <div class="bg-gray-900/50 p-4 rounded-xl border border-gray-700">
                <h4 class="text-xs font-bold text-gray-500 mb-1 uppercase tracking-widest">Profile</h4>
                <div id="detail-story" class="text-sm text-gray-300 italic leading-relaxed"></div>
            </div>
            
            <div id="detail-upgrade-section" class="bg-gray-700/50 p-4 rounded-xl border border-gray-600">
                <div class="flex justify-between items-end mb-2"><div class="text-white font-bold">ç­‰ç´š <span id="detail-lvl" class="text-2xl text-blue-400">1</span> <span class="text-gray-500 text-sm">/ <span id="detail-max-lvl">20</span></span></div><div class="text-xs text-gray-400">EXP: <span id="detail-global-exp" class="text-blue-300">0</span></div></div>
                <div class="exp-bar-container mb-4"><div class="exp-bar-fill w-0" id="detail-exp-bar"></div></div>
                <div id="detail-buttons" class="flex gap-2">
                    <button id="btn-levelup" onclick="performLevelUp()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-bold">å‡ç´š</button>
                    <button id="btn-evolve" onclick="performEvolve()" class="flex-1 bg-purple-600 hover:bg-purple-500 text-white py-3 rounded-lg font-bold">çªç ´ (é¤˜:<span id="detail-dupes">0</span>)</button>
                    <div id="max-level-msg" class="hidden flex-1 text-center py-3 text-yellow-400 font-bold border border-yellow-400/30 rounded-lg bg-yellow-900/20">MAX LEVEL</div>
                </div>
            </div>
            <div id="detail-unowned-msg" class="hidden bg-gray-900/80 p-6 rounded-xl border border-gray-700 text-center"><i class="fas fa-lock text-4xl text-gray-500 mb-2"></i><div class="text-gray-400 font-bold">å°šæœªç²å¾—æ­¤è§’è‰²</div></div>
        </div>
    </div>

    <!-- Header -->
    <div class="fixed top-0 left-0 w-full p-4 z-40 pointer-events-none flex justify-between items-start">
        <div class="pointer-events-auto bg-gray-900/60 backdrop-blur border border-white/10 rounded-lg px-4 py-2 flex items-center gap-3 shadow-lg cursor-pointer hover:bg-gray-800/80 transition" onclick="openSettings()">
             <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold border-2 border-blue-400 relative">
                <i class="fas fa-user"></i>
                <div class="absolute -bottom-1 -right-1 bg-gray-700 rounded-full w-5 h-5 flex items-center justify-center border border-gray-500 text-[10px]"><i class="fas fa-cog"></i></div>
             </div>
             <div><div class="text-[10px] text-gray-300 tracking-widest">COMMANDER</div><div class="text-sm font-bold text-white">PLAYER (è¨­å®š)</div></div>
        </div>
        <div class="pointer-events-auto flex flex-col items-end gap-2">
            <div class="flex items-center gap-2">
                 <div class="flex items-center gap-2 bg-gray-900/80 px-3 py-1.5 rounded-full border border-gray-700 shadow-lg min-w-[100px] backdrop-blur-sm"><i class="fas fa-book text-blue-400"></i><span id="exp-display" class="font-mono text-sm font-bold text-white">0</span></div>
                 <div class="flex items-center gap-2 bg-gray-900/80 px-3 py-1.5 rounded-full border border-gray-700 shadow-lg min-w-[100px] backdrop-blur-sm"><i class="fas fa-gem text-purple-400"></i><span id="gem-display" class="font-mono text-sm font-bold text-white">0</span></div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div id="game-container" class="relative w-full h-full bg-gray-900 overflow-hidden flex flex-col">
        
        <!-- Lobby -->
        <div id="view-lobby" class="absolute inset-0 w-full h-full flex flex-col lobby-bg-pattern">
            <button onclick="switchView('gacha')" class="absolute top-[18%] left-1/2 transform -translate-x-1/2 z-20 group flex flex-col items-center justify-center cursor-pointer hover:scale-110 transition">
                <div class="relative w-32 h-32 flex items-center justify-center">
                    <div class="w-3 h-3 bg-white rounded-full absolute z-10 star-glow"></div>
                </div>
                <span class="mt-4 text-sm text-white/50 tracking-[0.3em] font-light uppercase font-mono">å¬å–š</span>
            </button>
            <div class="flex-1 relative z-10 flex flex-col justify-end p-8 pb-32">
                <div class="flex justify-end items-end">
                    <button onclick="switchView('adventure')" class="group relative w-44 h-44 flex items-center justify-center transition-transform hover:scale-105 active:scale-95 focus:outline-none">
                        <div class="absolute inset-0 rounded-full bg-red-600 blur-xl opacity-40 group-hover:opacity-70 animate-pulse"></div>
                        <div class="absolute inset-0 rounded-full border-2 border-dashed border-yellow-500/60 animate-[spin_10s_linear_infinite] group-hover:border-yellow-400"></div>
                        <div class="relative w-36 h-36 rounded-full bg-gradient-to-br from-gray-800 to-black border-4 border-yellow-600 flex flex-col items-center justify-center shadow-2xl overflow-hidden group-hover:border-yellow-400 transition-colors">
                            <div class="absolute inset-0 bg-gradient-to-t from-red-900/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                            <div class="relative z-10 flex flex-col items-center transform group-hover:-translate-y-1 transition-transform">
                                <i class="fas fa-meteor text-4xl mb-1 text-yellow-500 filter drop-shadow-[0_0_8px_rgba(234,179,8,0.8)]"></i>
                                <span class="text-2xl font-black italic tracking-widest text-transparent bg-clip-text bg-gradient-to-b from-white to-gray-400 drop-shadow-sm">å‡ºæ“Š</span>
                                <span class="text-[9px] text-yellow-500/80 tracking-[0.2em] font-mono mt-1">BATTLE</span>
                            </div>
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Adventure -->
        <div id="view-adventure" class="hidden absolute inset-0 w-full h-full flex flex-col p-6 pt-24 bg-gray-900">
            <div class="flex items-center gap-4 mb-4 z-10">
                <button onclick="switchView('lobby')" class="text-gray-400 hover:text-white"><i class="fas fa-arrow-left text-2xl"></i></button>
                <h2 class="text-3xl font-black text-white tracking-widest uppercase">æˆ°å½¹é¸æ“‡</h2>
            </div>
            <div class="flex gap-4 mb-6 z-10">
                <button id="tab-story" onclick="switchCampaignTab('story')" class="flex-1 py-3 bg-blue-600 rounded-lg font-bold text-white shadow-lg border-2 border-blue-400 transition-all hover:bg-blue-500">
                    <i class="fas fa-book-open mr-2"></i>ä¸»ç·šåŠ‡æƒ…
                </button>
                <button id="tab-resource" onclick="switchCampaignTab('resource')" class="flex-1 py-3 bg-gray-700 rounded-lg font-bold text-gray-300 border-2 border-gray-600 transition-all hover:bg-gray-600 hover:text-white">
                    <i class="fas fa-coins mr-2"></i>è³‡æºå‰¯æœ¬
                </button>
            </div>
            <div class="flex-1 overflow-y-auto custom-scrollbar z-10 pb-24 min-h-0">
                <div id="campaign-list" class="flex flex-col gap-4 max-w-2xl mx-auto"></div>
            </div>
        </div>

        <!-- Chars -->
        <div id="view-chars" class="hidden absolute inset-0 w-full h-full flex flex-col p-6 pt-24 bg-gray-900">
            <div class="flex items-center gap-4 mb-6 z-10">
                <button onclick="switchView('lobby')" class="text-gray-400 hover:text-white"><i class="fas fa-arrow-left text-2xl"></i></button>
                <h2 class="text-3xl font-black text-white tracking-widest uppercase">è§’è‰²åˆ—è¡¨</h2>
            </div>
            <div id="chars-list-container" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4 overflow-y-auto pb-4 z-10 custom-scrollbar content-start flex-1 min-h-0"></div>
        </div>

        <!-- Team -->
        <div id="view-team" class="hidden absolute inset-0 w-full h-full flex flex-col p-6 pt-24 bg-gray-900">
            <div class="flex items-center gap-4 mb-6 z-10">
                <button onclick="switchView('lobby')" class="text-gray-400 hover:text-white"><i class="fas fa-arrow-left text-2xl"></i></button>
                <h2 class="text-3xl font-black text-white tracking-widest uppercase">ç·¨éšŠç³»çµ±</h2>
            </div>
            <div class="mb-6 shrink-0 relative z-10">
                <div class="flex items-center justify-between mb-3 px-1"><span id="team-count-display" class="text-gray-400 text-xs font-mono">0/5 UNITS</span></div>
                <div class="bg-gray-800 p-1 rounded-2xl border border-gray-700"><div id="current-team-container" class="flex justify-start md:justify-center gap-2 min-h-[160px] overflow-x-auto items-center py-4 px-2 relative custom-scrollbar"></div></div>
            </div>
            <div class="flex-1 overflow-hidden flex flex-col min-h-0 bg-gray-800/50 rounded-2xl border border-gray-700/50 relative z-10">
                <div class="shrink-0 p-4 border-b border-gray-700 flex justify-between items-center bg-gray-800/80"><h3 class="text-lg font-bold text-white">å¯é¸è§’è‰²</h3></div>
                <div id="inventory-container" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4 overflow-y-auto p-4 pb-4 flex-1 min-h-0 content-start custom-scrollbar"></div>
            </div>
        </div>

        <!-- Gallery -->
        <div id="view-gallery" class="hidden absolute inset-0 w-full h-full flex flex-col p-6 pt-24 bg-gray-900">
            <div class="flex items-center gap-4 mb-6 z-10">
                <button onclick="switchView('lobby')" class="text-gray-400 hover:text-white"><i class="fas fa-arrow-left text-2xl"></i></button>
                <div><h2 class="text-3xl font-black text-white tracking-widest uppercase">è§’è‰²åœ–é‘‘</h2><span id="gallery-progress" class="text-xs text-gray-500 font-normal">0/0</span></div>
            </div>
            <div id="gallery-list-container" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4 overflow-y-auto pb-4 z-10 custom-scrollbar content-start flex-1 min-h-0"></div>
        </div>

        <!-- Battle -->
        <div id="view-battle" class="hidden absolute inset-0 w-full h-full flex flex-col bg-gray-900 pt-16">
            <button id="btn-auto-battle" onclick="toggleAutoBattle()" class="absolute top-20 right-4 z-50 bg-gray-700/80 border border-gray-500 text-white px-4 py-2 rounded-full font-bold text-xs">AUTO <span id="auto-status">OFF</span></button>
            <div id="battle-result-overlay" class="fixed inset-0 z-[60] hidden flex-col items-center justify-center bg-black bg-opacity-90 backdrop-blur-md">
                <h2 id="battle-result-title" class="text-6xl font-black text-white mb-4">VICTORY</h2>
                <div id="battle-result-reward" class="text-xl text-gray-300 mb-2"></div>
                <button onclick="closeBattleResult()" class="mt-8 px-10 py-4 bg-white text-black font-black text-xl rounded-full">è¿”å›å¤§å»³</button>
            </div>
            <div class="flex-1 flex flex-col justify-between p-2 relative overflow-y-auto bg-gray-900">
                <div id="enemy-container" class="flex justify-center gap-1 py-4 items-end min-h-[160px] z-10"></div>
                <div id="player-container" class="flex justify-center gap-1 py-4 z-10 items-end min-h-[160px]"></div>
            </div>
            <div class="h-auto bg-gray-800 border-t border-gray-600 flex flex-col shrink-0 relative pb-4">
                <div class="p-3 flex flex-col justify-center"><div id="skill-container" class="grid grid-cols-3 gap-2 max-w-2xl mx-auto w-full"></div></div>
            </div>
            <div id="turn-indicator" class="absolute top-1/3 left-0 w-full text-center hidden z-50 pointer-events-none"><div class="bg-black/50 text-white text-4xl font-black py-4"><span id="turn-text">Player Turn</span></div></div>
        </div>

        <!-- Gacha -->
        <div id="view-gacha" class="hidden absolute inset-0 w-full h-full flex flex-col p-6 pt-24 bg-gray-900 overflow-y-auto">
            <div class="flex items-center gap-4 mb-2 z-10 w-full max-w-4xl mx-auto">
                <button onclick="switchView('lobby')" class="text-gray-400 hover:text-white"><i class="fas fa-arrow-left text-2xl"></i></button>
                <h2 class="text-3xl font-black text-white tracking-widest uppercase">å¬å–šç³»çµ±</h2>
            </div>
            <div class="z-10 flex flex-col items-center justify-center flex-1 my-auto">
                <div class="mb-10 relative group cursor-pointer hover:scale-110 transition" onclick="pullGacha(1)">
                    <div class="w-56 h-56 rounded-full border-2 border-indigo-400 flex items-center justify-center bg-gray-900 relative">
                        <i class="fas fa-star text-7xl text-indigo-400"></i>
                    </div>
                    <div class="absolute -bottom-5 left-1/2 transform -translate-x-1/2 bg-indigo-600 px-6 py-2 rounded-full text-sm font-bold text-white">SUMMON</div>
                </div>
                <div class="flex gap-6 justify-center w-full max-w-lg">
                    <button onclick="pullGacha(1)" class="flex-1 bg-gray-700 text-white font-bold py-4 rounded-xl">å–®æ¬¡å¬å–š (100)</button>
                    <button onclick="pullGacha(10)" class="flex-1 bg-yellow-700 text-white font-bold py-4 rounded-xl">åé€£å¬å–š (1000)</button>
                </div>
            </div>
            <div id="gacha-result" class="absolute inset-0 bg-black bg-opacity-95 z-50 hidden flex-col items-center justify-center overflow-y-auto p-4">
                <div class="my-auto flex flex-col items-center w-full max-w-4xl">
                    <h2 class="text-4xl text-white font-black mb-10">RESULT</h2>
                    <!-- Updated Container Class for Grid Layout -->
                    <div id="gacha-cards-container" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-12 w-full"></div>
                    <button onclick="closeGachaResult()" class="bg-white text-black font-bold py-3 px-12 rounded-full">ç¢ºèª</button>
                </div>
            </div>
        </div>

        <!-- Nav -->
        <div id="main-nav" class="fixed bottom-8 left-8 z-50 flex gap-6 pointer-events-none">
            <button onclick="switchView('chars')" class="pointer-events-auto w-20 h-20 rounded-full bg-blue-900/80 border-2 border-blue-500 text-white flex flex-col items-center justify-center"><i class="fas fa-user-astronaut text-2xl"></i><span class="text-[10px]">è§’è‰²</span></button>
            <button onclick="switchView('team')" class="pointer-events-auto w-20 h-20 rounded-full bg-green-900/80 border-2 border-green-500 text-white flex flex-col items-center justify-center"><i class="fas fa-users text-2xl"></i><span class="text-[10px]">éšŠä¼</span></button>
            <button onclick="switchView('gallery')" class="pointer-events-auto w-20 h-20 rounded-full bg-purple-900/80 border-2 border-purple-500 text-white flex flex-col items-center justify-center"><i class="fas fa-book-atlas text-2xl"></i><span class="text-[10px]">åœ–é‘‘</span></button>
        </div>
    </div>

    <script>
        const UI = {
            setText: (id, text) => { const el = document.getElementById(id); if(el) el.innerText = text; },
            setHtml: (id, html) => { const el = document.getElementById(id); if(el) el.innerHTML = html; },
            setSrc: (id, src) => { const el = document.getElementById(id); if(el) el.src = src; },
            addClass: (id, cls) => { const el = document.getElementById(id); if(el) el.classList.add(cls); },
            removeClass: (id, cls) => { const el = document.getElementById(id); if(el) el.classList.remove(cls); },
            hide: (id) => { const el = document.getElementById(id); if(el) el.classList.add('hidden'); },
            show: (id) => { const el = document.getElementById(id); if(el) el.classList.remove('hidden'); },
            showFlex: (id) => { const el = document.getElementById(id); if(el) { el.classList.remove('hidden'); el.classList.add('flex'); } },
            hideFlex: (id) => { const el = document.getElementById(id); if(el) { el.classList.add('hidden'); el.classList.remove('flex'); } }
        };

        const SoundManager={ctx:null,muted:false,init:function(){if(this.ctx)return;try{const AC=window.AudioContext||window.webkitAudioContext;this.ctx=new AC()}catch(e){}},toggleMute:function(){this.muted=!this.muted},play:function(t){if(this.muted)return;try{if(!this.ctx)this.init();if(this.ctx&&this.ctx.state==='suspended')this.ctx.resume();if(!this.ctx)return;const o=this.ctx.createOscillator(),g=this.ctx.createGain();o.connect(g);g.connect(this.ctx.destination);if(t==='click'){o.frequency.value=600;g.gain.value=0.05;o.start();o.stop(this.ctx.currentTime+0.05)}else if(t==='gacha'){this.playNote(523,0);this.playNote(659,0.1);this.playNote(784,0.2)}else if(t==='ssr_anim'){o.type='triangle';o.frequency.setValueAtTime(200,this.ctx.currentTime);o.frequency.exponentialRampToValueAtTime(800,this.ctx.currentTime+2.5);g.gain.setValueAtTime(0.1,this.ctx.currentTime);g.gain.linearRampToValueAtTime(0,this.ctx.currentTime+3);o.start();o.stop(this.ctx.currentTime+3)}}catch(e){}},playNote:function(f,d){try{const o=this.ctx.createOscillator(),g=this.ctx.createGain();o.connect(g);g.connect(this.ctx.destination);o.frequency.value=f;g.gain.value=0.05;g.gain.linearRampToValueAtTime(0,this.ctx.currentTime+d+0.1);o.start(this.ctx.currentTime+d);o.stop(this.ctx.currentTime+d+0.1)}catch(e){}}};
        
        // Added 'spd' (Speed) to all characters
        const CHARACTERS_DB = [
            { id: 'ssr1', name: 'è–å…‰é¨å£«', rarity: 'SSR', icon: 'ğŸ‘‘', type: 'phys', element: 'light', hp: 200, atk: 45, def: 20, spd: 90, seed: 'Paladin', bg: 'fef3c7', 
              passive: { name: 'è–æ½”å…‰ç’°', desc: 'å…¨é«”éšŠå‹é˜²ç¦¦åŠ›æå‡ 10%', type: 'team_def', val: 0.1 },
              story: "ç‹åœ‹æœ€å¹´è¼•çš„é¨å£«åœ˜é•·ï¼Œèª“è¨€ç”¨æ‰‹ä¸­çš„åŠå®ˆè­·æ‰€æœ‰å¼±è€…ã€‚å‚³èªªä»–çš„åŠåˆƒåœ¨æ»¿æœˆä¹‹å¤œæœƒç™¼å‡ºç¥è–çš„å…‰èŠ’ï¼Œæ·¨åŒ–ä¸€åˆ‡é‚ªæƒ¡ã€‚", 
              skills: [{name:'è–åŠæ–¬',type:'dmg',val:1.0,cd:0},{name:'è–å…‰åº‡è­·',type:'heal',val:80,cd:2,status:{type:'taunt',val:1,dur:2,name:'è–ç›¾å˜²è«·'}},{name:'ç¥è–å¯©åˆ¤',type:'dmg',val:2.5,cd:4}] },
            { id: 'ssr2', name: 'è™›ç©ºæ³•å¸«', rarity: 'SSR', icon: 'ğŸ”®', type: 'mag', element: 'dark', hp: 140, atk: 60, def: 10, spd: 105, seed: 'Witch', bg: 'e9d5ff', 
              passive: { name: 'è™›ç©ºçŸ¥è­˜', desc: 'è‡ªèº«æ”»æ“ŠåŠ›æå‡ 20%', type: 'self_atk', val: 0.2 },
              story: "æ›¾æ˜¯çš‡å®¶å­¸é™¢çš„å¤©æ‰å­¸è€…ï¼Œç‚ºäº†è¿½æ±‚ç©¶æ¥µçš„çœŸç†è€Œè¸å…¥ç¦å¿Œçš„è™›ç©ºé ˜åŸŸã€‚ç¾åœ¨çš„å¥¹ï¼Œæ—¢æ˜¯çŸ¥è­˜çš„åŒ–èº«ï¼Œä¹Ÿæ˜¯æ·±æ·µçš„ä»£è¨€äººã€‚", 
              skills: [{name:'æš—å½±çƒ',type:'dmg',val:1.0,cd:0},{name:'è™›ç©ºçˆ†è£‚',type:'aoe',val:0.8,cd:3},{name:'é»‘æ´åå™¬',type:'dmg',val:2.5,cd:4}] },
            { id: 'ssr3', name: 'é¾è¡€æˆ°å£«', rarity: 'SSR', icon: 'ğŸ²', type: 'phys', element: 'fire', hp: 220, atk: 50, def: 15, spd: 95, seed: 'DragonSlayer', bg: 'fee2e2', 
              passive: { name: 'é¾ä¹‹çš®è†š', desc: 'è‡ªèº«ç”Ÿå‘½å€¼æå‡ 20%', type: 'self_hp', val: 0.2 },
              story: "å‚³èªªä¸­æ²æµ´éå¤é¾ä¹‹è¡€çš„ç‹‚æˆ°å£«ï¼Œé«”å…§æµæ·Œè‘—ä¸æ»…çš„ç«ç„°ã€‚ä»–æ®èˆå·¨åŠæ™‚ç”¢ç”Ÿçš„ç†±æµªï¼Œè¶³ä»¥å°‡é‹¼éµèåŒ–ã€‚", 
              skills: [{name:'é¾çˆªæ“Š',type:'dmg',val:1.0,cd:0},{name:'å—œè¡€æ‰“æ“Š',type:'lifesteal',val:1.5,cd:3},{name:'é¾ä¹‹åæ¯',type:'aoe',val:1.2,cd:5}] },
            { id: 'ssr4', name: 'æ­»éˆè¡“å£«', rarity: 'SSR', icon: 'ğŸ’€', type: 'mag', element: 'dark', hp: 160, atk: 55, def: 12, spd: 100, seed: 'Necromancer', bg: '4a5568', 
              passive: { name: 'äº¡è€…æ°£æ¯', desc: 'æˆ°é¬¥é–‹å§‹æ™‚ï¼Œæ•µæ–¹å…¨é«”æ”»æ“ŠåŠ›é™ä½ 5%', type: 'enemy_debuff_atk', val: 0.05 },
              story: "æŒæ¡ç”Ÿèˆ‡æ­»ç•Œé™çš„ç¦å¿Œæ³•å¸«ï¼Œèƒ½å¬å–šäº¡è€…è»åœ˜ç‚ºå…¶ä½œæˆ°ã€‚é›–ç„¶è¢«ä¸–äººç•æ‡¼ï¼Œä½†ä»–å …ä¿¡åŠ›é‡æœ¬èº«æ²’æœ‰å–„æƒ¡ä¹‹åˆ†ã€‚", 
              skills: [{name:'éˆé­‚æ”¶å‰²',type:'dmg',val:1.0,cd:0},{name:'æ­»äº¡å‡‹é›¶',type:'aoe',val:0.9,cd:3,status:{type:'poison',val:0.3,dur:2,name:'ä¸­æ¯’'}},{name:'äº¡è€…å¤§è»',type:'aoe',val:1.5,cd:5}] },
            { id: 'ssr5', name: 'æ©Ÿæ¢°æˆ°ç¥', rarity: 'SSR', icon: 'ğŸ¤–', type: 'phys', element: 'earth', hp: 250, atk: 40, def: 25, spd: 85, seed: 'Mecha', bg: 'cbd5e0', 
              passive: { name: 'åæ‡‰è£ç”²', desc: 'è‡ªèº«é˜²ç¦¦åŠ›æå‡ 25%', type: 'self_def', val: 0.25 },
              story: "å¤ä»£æ–‡æ˜éºç•™ä¸‹ä¾†çš„çµ‚æ¥µå…µå™¨ï¼Œæ“æœ‰è‡ªæˆ‘æ„è­˜ã€‚ç¶“éåƒå¹´çš„æ²‰ç¡å¾Œç”¦é†’ï¼Œå°‹æ‰¾è‘—å‰µé€ å®ƒçš„ä¸»äººã€‚", 
              skills: [{name:'ç«ç®­æ‹³',type:'dmg',val:1.1,cd:0},{name:'èƒ½é‡è­·ç›¾',type:'heal',val:60,cd:3,status:{type:'def_up',val:0.5,dur:2,name:'è­·ç›¾'}},{name:'å…¨å½ˆç™¼å°„',type:'aoe',val:1.4,cd:5}] },
            { id: 'ssr6', name: 'å¤§å¤©ä½¿', rarity: 'SSR', icon: 'ğŸ‘¼', type: 'mag', element: 'light', hp: 180, atk: 35, def: 18, spd: 100, seed: 'Angel', bg: 'fffaf0', 
              passive: { name: 'ç¥ä¹‹æ©å¯µ', desc: 'å…¨é«”éšŠå‹ç”Ÿå‘½å€¼æå‡ 15%', type: 'team_hp', val: 0.15 },
              story: "ä¾†è‡ªå¤©ç•Œçš„ä½¿è€…ï¼Œæ“æœ‰çš„æ²»ç™’åŠ›é‡èƒ½è®“æ¯æœ¨é€¢æ˜¥ã€‚å¥¹é™è‡¨å‡¡é–“æ˜¯ç‚ºäº†å¹³æ¯æˆ°äº‚ï¼Œå¸¶çµ¦äººå€‘å¸Œæœ›ã€‚", 
              skills: [{name:'è–å…‰å½ˆ',type:'dmg',val:1.0,cd:0},{name:'ç¥ä¹‹æ©æƒ ',type:'heal',val:100,cd:2,status:{type:'regen',val:0.1,dur:3,name:'å†ç”Ÿ'}},{name:'å¥‡è¹Ÿå¾©ç”¦',type:'heal',val:200,cd:5}] },
            
            { id: 'sr1', name: 'çš‡å®¶å°„æ‰‹', rarity: 'SR', icon: 'ğŸ¹', type: 'phys', element: 'wind', hp: 120, atk: 35, def: 8, spd: 120, seed: 'Ranger', bg: 'd1fae5', 
              passive: { name: 'é·¹çœ¼', desc: 'è‡ªèº«çˆ†æ“Šç‡æå‡ 10%', type: 'crit_rate', val: 0.1 },
              story: "ç²¾éˆç‹æ—çš„è­·è¡›éšŠé•·ï¼Œæ“æœ‰é·¹ä¸€èˆ¬çš„è¦–åŠ›ã€‚æ“šèªªä»–çš„ç®­çŸ¢å¾æœªå¤±æ‰‹ï¼Œèƒ½åœ¨ç™¾æ­¥ä¹‹å¤–å°„ç©¿æ•µäººçš„ç›”ç”²ç¸«éš™ã€‚", 
              skills: [{name:'ç²¾æº–å°„æ“Š',type:'dmg',val:1.0,cd:0},{name:'äºŒé€£çŸ¢',type:'dmg',val:1.6,cd:2},{name:'çˆ†è£‚ç®­',type:'aoe',val:0.7,cd:4}] },
            { id: 'sr2', name: 'æˆ°é¬¥ç‰§å¸«', rarity: 'SR', icon: 'ğŸ”¨', type: 'phys', element: 'light', hp: 160, atk: 25, def: 15, spd: 90, seed: 'Cleric', bg: 'f3f4f6', 
              passive: { name: 'å …å®šä¿¡ä»°', desc: 'è‡ªèº«æ”»æ“ŠåŠ›æå‡ 15%', type: 'self_atk', val: 0.15 },
              story: "é›–ç„¶éš¸å±¬æ–¼æ•™æœƒï¼Œä½†ä»–å …ä¿¡ã€Œç‰©ç†è¶…åº¦ã€ä¹Ÿæ˜¯ä¸€ç¨®æ…ˆæ‚²ã€‚æ¯”èµ·ç¥ˆç¦±ï¼Œä»–æ›´æ“…é•·ç”¨æ‰‹ä¸­çš„æˆ°éŒ˜ç²‰ç¢ç•°ç«¯ã€‚", 
              skills: [{name:'æˆ°éŒ˜æ“Š',type:'dmg',val:1.0,cd:0},{name:'ç¥è–æ–°æ˜Ÿ',type:'heal',val:50,cd:3},{name:'å¯©åˆ¤ä¹‹å…‰',type:'dmg',val:2.0,cd:4}] },
            { id: 'sr3', name: 'æš—å½±åˆºå®¢', rarity: 'SR', icon: 'ğŸ—¡ï¸', type: 'phys', element: 'dark', hp: 100, atk: 45, def: 5, spd: 125, seed: 'Ninja', bg: 'e5e7eb', 
              passive: { name: 'é¬¼æ­¥', desc: 'è‡ªèº«é–ƒé¿ç‡æå‡ 10%', type: 'dodge', val: 0.1 },
              story: "ä¾†è‡ªæ±æ–¹ç¥ç§˜å³¶åœ‹çš„æµæµªå¿è€…ï¼Œæ²’æœ‰åå­—ï¼Œåªæœ‰ä»£è™Ÿã€‚åªè¦ä»˜å¾—èµ·è¶³å¤ çš„é»ƒé‡‘ï¼Œä»–å°±èƒ½æˆç‚ºä½ æœ€é‹’åˆ©çš„å½±å­ã€‚", 
              skills: [{name:'èƒŒåˆº',type:'dmg',val:1.0,cd:0},{name:'å¡—æ¯’åŒ•é¦–',type:'dmg',val:1.5,cd:2,status:{type:'poison',val:0.1,dur:3,name:'åŠ‡æ¯’'}},{name:'è‡´å‘½ä¸€æ“Š',type:'dmg',val:3.0,cd:5}] },
            { id: 'sr4', name: 'å…ƒç´ ä½¿è€…', rarity: 'SR', icon: 'ğŸ”¥', type: 'mag', element: 'fire', hp: 110, atk: 40, def: 8, spd: 105, seed: 'Pyromancer', bg: 'ffedd5', 
              passive: { name: 'ç«ç„°è¦ªå’Œ', desc: 'é€ æˆç«å±¬æ€§å‚·å®³æå‡ 20%', type: 'ele_fire_up', val: 0.2 },
              story: "ç™¡è¿·æ–¼ç«ç„°é­”æ³•çš„ç˜‹ç‹‚æ³•å¸«ï¼Œæ€§æ ¼å¦‚åŒä»–å¬å–šçš„çƒˆç„°ä¸€æ¨£ä¸ç©©å®šã€‚æ¯”èµ·æ“Šæ•—æ•µäººï¼Œä»–æ›´äº«å—ç‡ƒç‡’çš„éç¨‹ã€‚", 
              skills: [{name:'ç«çƒè¡“',type:'dmg',val:1.0,cd:0,status:{type:'burn',val:0.2,dur:2,name:'ç‡ƒç‡’'}},{name:'çƒˆç„°é¢¨æš´',type:'aoe',val:0.6,cd:3},{name:'ç‚çˆ†è¡“',type:'dmg',val:2.2,cd:4}] },
            { id: 'sr5', name: 'ç‹‚æˆ°å£«', rarity: 'SR', icon: 'ğŸª“', type: 'phys', element: 'earth', hp: 140, atk: 50, def: 5, spd: 95, seed: 'Berserker', bg: 'feb2b2', 
              passive: { name: 'ä¸å±ˆ', desc: 'è‡ªèº«æ”»æ“ŠåŠ›æå‡ 12%', type: 'self_atk', val: 0.12 },
              story: "ä¾†è‡ªåŒ—æ–¹å‡åœŸçš„é‡è »æˆ°å£«ï¼Œä¸€æ—¦é€²å…¥æˆ°é¬¥ç‹€æ…‹å°±æœƒå¤±å»ç†æ™ºï¼Œä¸é¡§å—å‚·ä¹Ÿè¦æ’•ç¢æ•µäººã€‚", 
              skills: [{name:'é‡åŠˆ',type:'dmg',val:1.2,cd:0},{name:'æ¨èº«ä¸€æ“Š',type:'dmg',val:1.8,cd:2},{name:'è¡€æ€’',type:'lifesteal',val:1.5,cd:4,status:{type:'atk_up',val:0.5,dur:3,name:'ç‹‚æš´'}}] },
            { id: 'sr6', name: 'å¾·é­¯ä¼Š', rarity: 'SR', icon: 'ğŸ¦Œ', type: 'mag', element: 'earth', hp: 150, atk: 30, def: 10, spd: 98, seed: 'Druid', bg: 'c6f6d5', 
              passive: { name: 'è‡ªç„¶åº‡è­·', desc: 'æˆ°é¬¥é–‹å§‹æ™‚ï¼Œç²å¾— 3 å›åˆå†ç”Ÿ', type: 'start_buff', buff: 'regen', val: 0.1, dur: 3 },
              story: "æ£®æ—çš„å®ˆè­·è€…ï¼Œèƒ½èˆ‡å‹•æ¤ç‰©æºé€šã€‚å¥¹é‹ç”¨è‡ªç„¶çš„åŠ›é‡æ‡²ç½°ç ´å£ç’°å¢ƒçš„å…¥ä¾µè€…ã€‚", 
              skills: [{name:'èŠæ£˜é­',type:'dmg',val:1.0,cd:0},{name:'è‡ªç„¶ç™’åˆ',type:'heal',val:40,cd:3,status:{type:'regen',val:0.1,dur:3,name:'å›æ˜¥'}},{name:'æ£®æ—ä¹‹æ€’',type:'aoe',val:0.8,cd:4}] },
            { id: 'sr7', name: 'è–æ®¿é¨å£«', rarity: 'SR', icon: 'ğŸ›¡ï¸', type: 'phys', element: 'light', hp: 180, atk: 25, def: 20, spd: 85, seed: 'Templar', bg: 'ebf8ff', 
              passive: { name: 'é‹¼éµæ„å¿—', desc: 'æˆ°é¬¥é–‹å§‹æ™‚ï¼Œç²å¾— 2 å›åˆé˜²ç¦¦æå‡', type: 'start_buff', buff: 'def_up', val: 0.3, dur: 2 },
              story: "æ•™æœƒçš„å¿ å¯¦å®ˆè¡›ï¼Œèº«ç©¿åšé‡çš„æ¿ç”²ã€‚ä»–çš„ç›¾ç‰Œä¸åƒ…èƒ½é˜²ç¦¦ï¼Œæ›´æ˜¯è¡æ’æ•µäººçš„åˆ©å™¨ã€‚", 
              skills: [{name:'ç›¾æ“Š',type:'dmg',val:1.0,cd:0,status:{type:'stun',chance:0.3,dur:1,name:'æšˆçœ©'}},{name:'å …å®ˆ',type:'heal',val:30,cd:3,status:{type:'def_up',val:0.3,dur:2,name:'å …å®ˆ',type:'taunt',val:1,dur:2,name:'å˜²è«·'}},{name:'æ­£ç¾©è¡é‹’',type:'dmg',val:1.6,cd:4}] },
            { id: 'sr8', name: 'å¹»è¡“å¸«', rarity: 'SR', icon: 'ğŸ­', type: 'mag', element: 'dark', hp: 110, atk: 42, def: 8, spd: 110, seed: 'Illusionist', bg: 'e9d8fd', 
              passive: { name: 'æ®˜å½±', desc: 'è‡ªèº«é–ƒé¿ç‡æå‡ 8%', type: 'dodge', val: 0.08 },
              story: "æ“…é•·æ“ç¸±äººå¿ƒçš„é­”è¡“å¸«ï¼Œå¸¸å¸¸è®“æ•µäººåœ¨å¹»è¦ºä¸­è‡ªæˆ‘æ¯€æ»…ã€‚æ²’äººè¦‹éä»–é¢å…·ä¸‹çš„çœŸé¢ç›®ã€‚", 
              skills: [{name:'ç²¾ç¥è¡æ“Š',type:'dmg',val:1.0,cd:0,status:{type:'stun',chance:0.3,dur:1,name:'æ··äº‚'}},{name:'é¡åƒ',type:'dmg',val:1.3,cd:2},{name:'å¤¢é­˜é™è‡¨',type:'aoe',val:0.7,cd:4}] },
            { id: 'sr9', name: 'æ­¦é“å®¶', rarity: 'SR', icon: 'ğŸ¥‹', type: 'phys', element: 'earth', hp: 140, atk: 38, def: 12, spd: 115, seed: 'Monk', bg: 'ffedd5', 
              passive: { name: 'é‡‘é˜ç½©', desc: 'è‡ªèº«é˜²ç¦¦åŠ›æå‡ 15%', type: 'self_def', val: 0.15 },
              story: "åœ¨æ·±å±±ä¿®è¡Œçš„æ ¼é¬¥å¤§å¸«ï¼Œå°‡è‚‰é«”é›éŠåˆ°äº†æ¥µè‡´ã€‚ä»–çš„æ‹³é ­æ¯”é‹¼éµé‚„ç¡¬ã€‚", 
              skills: [{name:'æ­£æ‹³',type:'dmg',val:1.1,cd:0},{name:'æ°£åŠŸæ³¢',type:'aoe',val:0.6,cd:3},{name:'é¾æ‹³çˆ†ç™¼',type:'dmg',val:2.0,cd:4}] },
            { id: 'sr10', name: 'åŸéŠè©©äºº', rarity: 'SR', icon: 'ğŸ¸', type: 'mag', element: 'wind', hp: 130, atk: 28, def: 10, spd: 100, seed: 'Bard', bg: 'fefcbf', 
              passive: { name: 'è‹±é›„è¬ ', desc: 'å…¨é«”éšŠå‹æ”»æ“ŠåŠ›æå‡ 5%', type: 'team_atk', val: 0.05 },
              story: "æµæµªå››æ–¹çš„éŸ³æ¨‚å®¶ï¼Œç”¨æ­Œè²æ¿€å‹µéšŠå‹ã€‚æ“šèªªä»–çš„æ›²å­èƒ½å–šé†’äººå€‘å…§å¿ƒæ·±è™•çš„åŠ›é‡ã€‚", 
              skills: [{name:'éŸ³æ³¢æ”»æ“Š',type:'dmg',val:1.0,cd:0},{name:'æ¿€å‹µä¹‹æ­Œ',type:'heal',val:40,cd:2,status:{type:'atk_up',val:0.2,dur:2,name:'æ¿€å‹µ'}},{name:'è‹±é›„äº¤éŸ¿æ›²',type:'aoe',val:0.6,cd:5}] },
            
            { id: 'r1', name: 'ç‹åœ‹æ­¥å…µ', rarity: 'R', icon: 'ğŸ’‚', type: 'phys', element: 'earth', hp: 100, atk: 20, def: 10, spd: 90, seed: 'Guard', bg: 'f1f5f9', 
              passive: { name: 'åŸºç¤è¨“ç·´', desc: 'è‡ªèº«é˜²ç¦¦åŠ›æå‡ 5%', type: 'self_def', val: 0.05 },
              story: "æœ€åŸºå±¤çš„è»éšŠåŠ›é‡ï¼Œé›–ç„¶è£å‚™ç°¡é™‹ï¼Œä½†æ“æœ‰å …å®šçš„æ„å¿—ã€‚ç‚ºäº†å®ˆè­·å®¶é„‰çš„è¾²ç”°ï¼Œä»–å€‘çµ•ä¸é€€ç¸®ã€‚", 
              skills: [{name:'çªåˆº',type:'dmg',val:1.0,cd:0},{name:'é˜²ç¦¦æ…‹å‹¢',type:'heal',val:20,cd:3,status:{type:'taunt',val:1,dur:1,name:'å˜²è«·'}},{name:'å…¨åŠ›ä¸€æ“Š',type:'dmg',val:1.5,cd:4}] },
            { id: 'r2', name: 'è¦‹ç¿’æ³•å¸«', rarity: 'R', icon: 'ğŸ•¯ï¸', type: 'mag', element: 'fire', hp: 80, atk: 25, def: 5, spd: 95, seed: 'Apprentice', bg: 'eff6ff', 
              passive: { name: 'é­”åŠ›å…±é³´', desc: 'è‡ªèº«æ”»æ“ŠåŠ›æå‡ 5%', type: 'self_atk', val: 0.05 },
              story: "é­”æ³•å­¸é™¢çš„ä¸€å¹´ç´šç”Ÿï¼Œé‚„ä¸èƒ½å®Œå…¨æ§åˆ¶é­”åŠ›ã€‚ç¶“å¸¸åœ¨ç·´ç¿’æ™‚ä¸å°å¿ƒç‚¸æ‰å¯¦é©—å®¤ï¼Œä½†æ½›åŠ›å‚™å—æœŸå¾…ã€‚", 
              skills: [{name:'èƒ½é‡å½ˆ',type:'dmg',val:1.0,cd:0},{name:'å°ˆæ³¨',type:'dmg',val:1.2,cd:2},{name:'ä¸ç©©å®šçš„çˆ†ç‚¸',type:'aoe',val:0.5,cd:4}] },
            { id: 'r3', name: 'æ£®æ—æ–¥å€™', rarity: 'R', icon: 'ğŸƒ', type: 'phys', element: 'wind', hp: 90, atk: 22, def: 6, spd: 110, seed: 'Scout', bg: 'ecfccb', 
              passive: { name: 'æ•éŠ³', desc: 'è‡ªèº«é–ƒé¿ç‡æå‡ 5%', type: 'dodge', val: 0.05 },
              story: "ç†Ÿæ‚‰æ£®æ—åœ°å½¢çš„åµæŸ¥å…µï¼Œæ“…é•·è¨­ç½®é™·é˜±å’Œè‰è—¥æ²»ç™‚ã€‚åœ¨é‡å¤–ç”Ÿå­˜é€™æ–¹é¢ï¼Œæ²’äººæ¯”ä»–æ›´åœ¨è¡Œã€‚", 
              skills: [{name:'å°„æ“Š',type:'dmg',val:1.0,cd:0},{name:'è‰è—¥åŒ…ç´®',type:'heal',val:30,cd:3},{name:'é™·é˜±ç®­',type:'dmg',val:1.4,cd:3}] },
            { id: 'r4', name: 'åƒ±å‚­å…µ', rarity: 'R', icon: 'ğŸ’°', type: 'phys', element: 'earth', hp: 110, atk: 25, def: 8, spd: 95, seed: 'Mercenary', bg: 'fff7ed', 
              passive: { name: 'è²ªå©ª', desc: 'è‡ªèº«æ”»æ“ŠåŠ›æå‡ 5%', type: 'self_atk', val: 0.05 },
              story: "åªèªéŒ¢ä¸èªäººçš„æµæµªæˆ°å£«ï¼Œé›–ç„¶æˆ°é¬¥é¢¨æ ¼ç²—é­¯ï¼Œä½†åœ¨æ··æˆ°ä¸­å»æ„å¤–åœ°å¯é ã€‚åªè¦å ±é…¬åˆ°ä½ï¼Œå·¨é¾ä¹Ÿæ•¢ç ã€‚", 
              skills: [{name:'æ®ç ',type:'dmg',val:1.0,cd:0},{name:'è »åŠ›é‡æ“Š',type:'dmg',val:1.3,cd:2},{name:'æ”¶éŒ¢è¾¦äº‹',type:'lifesteal',val:1.0,cd:4}] },
            { id: 'r5', name: 'æ‘æ°‘', rarity: 'R', icon: 'ğŸŒ¾', type: 'phys', element: 'earth', hp: 70, atk: 15, def: 2, spd: 80, seed: 'Peasant', bg: 'fafaf9', 
              passive: { name: 'æ±‚ç”Ÿæ„å¿—', desc: 'è‡ªèº«ç”Ÿå‘½å€¼æå‡ 10%', type: 'self_hp', val: 0.1 },
              story: "åŸæœ¬åªæ˜¯æƒ³ç¨®ç”°ï¼Œå»ç„¡å¥ˆè¢«æ²å…¥æˆ°çˆ­çš„å¯æ†äººã€‚é›–ç„¶æˆ°é¬¥åŠ›ä¸å¼·ï¼Œä½†æŠ•æ“²çŸ³é ­çš„æº–åº¦æ˜¯åœ¨è¶•é‡è±¬æ™‚ç·´å‡ºä¾†çš„ã€‚", 
              skills: [{name:'ä¸ŸçŸ³é ­',type:'dmg',val:1.0,cd:0},{name:'åƒéºµåŒ…',type:'heal',val:20,cd:3},{name:'å‘¼æ•‘',type:'dmg',val:0.5,cd:4}] },
            { id: 'r6', name: 'ç¤¦å·¥', rarity: 'R', icon: 'â›ï¸', type: 'phys', element: 'earth', hp: 110, atk: 22, def: 12, spd: 85, seed: 'Miner', bg: 'edf2f7', 
              passive: { name: 'å …ç¡¬çš®è†š', desc: 'è‡ªèº«é˜²ç¦¦åŠ›æå‡ 5%', type: 'self_def', val: 0.05 },
              story: "é•·å¹´åœ¨åœ°ä¸‹å·¥ä½œçš„å‹å‹•è€…ï¼ŒåŠ›æ°£å¾ˆå¤§ï¼Œæ‰‹ä¸­çš„åå­—é¬èƒ½é‘¿é–‹å …ç¡¬çš„å²©çŸ³ï¼Œä¹Ÿèƒ½é‘¿é–‹æ•µäººçš„è…¦è¢‹ã€‚", 
              skills: [{name:'é‘¿æ“Š',type:'dmg',val:1.0,cd:0},{name:'åƒä¾¿ç•¶',type:'heal',val:20,cd:3},{name:'ç‚¸è—¥æŠ•æ“²',type:'aoe',val:0.5,cd:4}] },
            { id: 'r7', name: 'å»šå¸«', rarity: 'R', icon: 'ğŸ³', type: 'phys', element: 'fire', hp: 100, atk: 20, def: 8, spd: 90, seed: 'Chef', bg: 'fff5f5', 
              passive: { name: 'ç‡Ÿé¤Šè£œçµ¦', desc: 'è‡ªèº«ç”Ÿå‘½å€¼æå‡ 5%', type: 'self_hp', val: 0.05 },
              story: "åŸæœ¬æ˜¯çš‡å®¶å¾¡å»šï¼Œå¾Œä¾†ç‚ºäº†å°‹æ‰¾å‚³èªªä¸­çš„é£Ÿæè€Œè¸ä¸Šæ—…ç¨‹ã€‚æˆ°é¬¥æ™‚æœƒç”¨å¹³åº•é‹ç‹ ç‹ æ•™è¨“å°æ‰‹ã€‚", 
              skills: [{name:'å¹³åº•é‹æ‹æ“Š',type:'dmg',val:1.0,cd:0},{name:'ç¾å‘³æ–™ç†',type:'heal',val:30,cd:3},{name:'ç†±æ²¹æ½‘ç‘',type:'aoe',val:0.4,cd:4}] },
            { id: 'r8', name: 'éµåŒ ', rarity: 'R', icon: 'ğŸ”¨', type: 'phys', element: 'fire', hp: 120, atk: 24, def: 10, spd: 85, seed: 'Blacksmith', bg: 'e2e8f0', 
              passive: { name: 'å¼·å£¯é«”é­„', desc: 'è‡ªèº«é˜²ç¦¦åŠ›æå‡ 5%', type: 'self_def', val: 0.05 },
              story: "æ‘è£¡çš„æ­¦å™¨è£½é€ è€…ï¼Œé›–ç„¶ä¸æ“…é•·æˆ°é¬¥æŠ€å·§ï¼Œä½†é è‘—ä¸€èº«è »åŠ›å’Œæ²‰é‡çš„éµéšä¹Ÿèƒ½é€ æˆä¸ä¿—çš„å‚·å®³ã€‚", 
              skills: [{name:'é›æ‰“',type:'dmg',val:1.0,cd:0},{name:'ä¿®è£œ',type:'heal',val:25,cd:3},{name:'é‡éŒ˜ç«èŠ±',type:'dmg',val:1.4,cd:4}] },
            { id: 'r9', name: 'ç›œè³Š', rarity: 'R', icon: 'ğŸ’°', type: 'phys', element: 'dark', hp: 85, atk: 26, def: 5, spd: 115, seed: 'Thief', bg: '1a202c', 
              passive: { name: 'éˆå·§', desc: 'è‡ªèº«é–ƒé¿ç‡æå‡ 5%', type: 'dodge', val: 0.05 },
              story: "åœ¨è²§æ°‘çªŸé•·å¤§çš„å­¤å…’ï¼Œç‚ºäº†ç”Ÿå­˜å­¸æœƒäº†å·ç«Šã€‚èº«æ‰‹æ•æ·ï¼Œèƒ½åœ¨æ•µäººåæ‡‰éä¾†å‰å–èµ°ä»–å€‘çš„è²¡ç‰©ã€‚", 
              skills: [{name:'å°åˆ€åŠƒæ“Š',type:'dmg',val:1.0,cd:0},{name:'å·è¥²',type:'dmg',val:1.3,cd:2},{name:'ç…™éœ§å½ˆ',type:'aoe',val:0.3,cd:4}] },
            { id: 'r10', name: 'è—¥åŠ‘å¸«', rarity: 'R', icon: 'ğŸ§ª', type: 'mag', element: 'water', hp: 90, atk: 20, def: 6, spd: 95, seed: 'Alchemist', bg: 'f0fff4', 
              passive: { name: 'åŒ–å­¸é˜²è­·', desc: 'è‡ªèº«é˜²ç¦¦åŠ›æå‡ 5%', type: 'self_def', val: 0.05 },
              story: "è‡´åŠ›æ–¼ç ”ç©¶è¬èƒ½è—¥çš„å­¸è€…ï¼Œç¶“å¸¸æ‹¿è‡ªå·±åšå¯¦é©—ã€‚æˆ°é¬¥ä¸­æœƒæŠ•æ“²å„ç¨®å¥‡æ€ªçš„è—¥æ°´ã€‚", 
              skills: [{name:'æ¯’è—¥ç“¶',type:'dmg',val:1.0,cd:0, status: {type:'poison', val:0.2, dur:3, name:'ä¸­æ¯’'}},{name:'æ²»ç™‚è—¥æ°´',type:'heal',val:35,cd:3},{name:'çˆ†ç‚¸è©¦åŠ‘',type:'aoe',val:0.5,cd:4}] },
            { id: 'r11', name: 'ä¼æœ¨å·¥', rarity: 'R', icon: 'ğŸª“', type: 'phys', element: 'earth', hp: 115, atk: 23, def: 9, spd: 85, seed: 'Lumberjack', bg: 'f6e05e', 
              passive: { name: 'ä¼æœ¨å‹', desc: 'è‡ªèº«æ”»æ“ŠåŠ›æå‡ 5%', type: 'self_atk', val: 0.05 },
              story: "æ“æœ‰é©šäººè‡‚åŠ›çš„ä¼æœ¨å·¥äººï¼Œå°ä»˜æ¨¹æœ¨å¾ˆæœ‰ä¸€å¥—ï¼Œå°ä»˜åƒæœ¨é ­ä¸€æ¨£çš„æ•µäººä¹Ÿå¾ˆæœ‰ä¸€å¥—ã€‚", 
              skills: [{name:'åŠˆç ',type:'dmg',val:1.0,cd:0},{name:'ä¼‘æ¯ä¸€ä¸‹',type:'heal',val:20,cd:3},{name:'è¿´æ—‹æ–§',type:'aoe',val:0.4,cd:4}] },
            { id: 'r12', name: 'æ°´æ‰‹', rarity: 'R', icon: 'âš“', type: 'phys', element: 'water', hp: 105, atk: 21, def: 8, spd: 90, seed: 'Sailor', bg: 'ebf8ff', 
              passive: { name: 'æµ·ä¹‹å­', desc: 'è‡ªèº«ç”Ÿå‘½å€¼æå‡ 5%', type: 'self_hp', val: 0.05 },
              story: "é•·æœŸåœ¨æµ·ä¸Šç”Ÿæ´»çš„ç²—ç·ç”·å­ï¼Œç¿’æ…£äº†é¢¨æµªã€‚æˆ°é¬¥é¢¨æ ¼åƒæµ·æµªä¸€æ¨£æ´¶æ¹§ã€‚", 
              skills: [{name:'å½åˆ€æ–¬',type:'dmg',val:1.0,cd:0},{name:'å–è˜­å§†é…’',type:'heal',val:25,cd:3},{name:'éŒ¨æ“Š',type:'dmg',val:1.3,cd:4}] },
            { id: 'r13', name: 'è­¦å‚™å“¡', rarity: 'R', icon: 'ğŸ‘®', type: 'phys', element: 'light', hp: 110, atk: 18, def: 12, spd: 95, seed: 'Police', bg: '4299e1', 
              passive: { name: 'åˆ¶æœå¨åš´', desc: 'è‡ªèº«é˜²ç¦¦åŠ›æå‡ 5%', type: 'self_def', val: 0.05 },
              story: "åŸé®æ²»å®‰çš„ç¶­è­·è€…ï¼Œé›–ç„¶å¹³æ™‚åªè™•ç†äº›å°å·å°æ‘¸ï¼Œä½†åœ¨å±æ€¥æ™‚åˆ»æœƒæŒºèº«è€Œå‡ºã€‚", 
              skills: [{name:'è­¦æ£',type:'dmg',val:1.0,cd:0},{name:'æ€¥æ•‘',type:'heal',val:20,cd:3},{name:'ç›¾ç‰Œè¡æ’',type:'dmg',val:1.2,cd:4}] },
            { id: 'r14', name: 'è¡—é ­è—äºº', rarity: 'R', icon: 'ğŸ¤¹', type: 'phys', element: 'wind', hp: 80, atk: 15, def: 5, spd: 115, seed: 'Juggler', bg: 'faf5ff', 
              passive: { name: 'é›œè€èº«æ³•', desc: 'è‡ªèº«é–ƒé¿ç‡æå‡ 5%', type: 'dodge', val: 0.05 },
              story: "åœ¨å»£å ´è¡¨æ¼”é›œè€çš„è—äººï¼Œèƒ½åŒæ™‚æ‹‹æ¥å¤šå€‹çƒã€‚æˆ°é¬¥æ™‚æŠŠæ­¦å™¨ç•¶ä½œé›œè€é“å…·ä¸Ÿå‘æ•µäººã€‚", 
              skills: [{name:'ä¸Ÿçƒ',type:'dmg',val:1.0,cd:0},{name:'å–å½©',type:'heal',val:15,cd:3},{name:'é£›åˆ€è¡¨æ¼”',type:'dmg',val:1.4,cd:4}] },
        ];

        // Added 'spd' to equipment
        const EQUIPMENT_DB = [
            { id: 'eq_w_r1', name: 'è¨“ç·´é•·åŠ', type: 'weapon', rarity: 'R', atk: 15, hp: 0, spd: 0, desc: 'å£«å…µå¸¸ç”¨çš„æ¨™æº–æ­¦å™¨', icon: 'âš”ï¸' },
            { id: 'eq_w_sr1', name: 'ç§˜éŠ€ç´°åŠ', type: 'weapon', rarity: 'SR', atk: 40, hp: 0, spd: 5, desc: 'è¼•ç›ˆä¸”é‹’åˆ©çš„é­”æ³•é‡‘å±¬åŠ', icon: 'ğŸ—¡ï¸' },
            { id: 'eq_w_ssr1', name: 'æ˜Ÿéš•å·¨åŠ', type: 'weapon', rarity: 'SSR', atk: 100, hp: 50, spd: 0, desc: 'æ“šèªªç”±éš•çŸ³æ‰“é€ çš„ç¥å™¨', icon: 'â˜„ï¸' },
            { id: 'eq_a_r1', name: 'çš®é©è­·ç”²', type: 'armor', rarity: 'R', atk: 0, hp: 100, spd: 2, desc: 'åŸºæœ¬çš„é˜²è­·è£å‚™', icon: 'ğŸ›¡ï¸' },
            { id: 'eq_a_sr1', name: 'é¨å£«æ¿ç”²', type: 'armor', rarity: 'SR', atk: 0, hp: 300, spd: -5, desc: 'å …å›ºçš„é‹¼éµç›”ç”²', icon: 'ğŸ°' },
            { id: 'eq_a_ssr1', name: 'é¾é±—æˆ°ç”²', type: 'armor', rarity: 'SSR', atk: 20, hp: 800, spd: 0, desc: 'æ“æœ‰é¾ä¹‹åŠ›é‡çš„å‚³å¥‡è­·ç”²', icon: 'ğŸ‰' },
            { id: 'eq_ac_r1', name: 'éŠ…æˆ’æŒ‡', type: 'accessory', rarity: 'R', atk: 5, hp: 50, spd: 0, desc: 'æ™®é€šçš„è£é£¾å“', icon: 'ğŸ’' },
            { id: 'eq_b_r1', name: 'çš®é´', type: 'accessory', rarity: 'R', atk: 0, hp: 20, spd: 10, desc: 'è¼•ä¾¿çš„çš®é´ï¼Œæ–¹ä¾¿ç§»å‹•ã€‚', icon: 'ğŸ‘¢' },
            { id: 'eq_ac_sr1', name: 'å®ˆè­·è­·ç¬¦', type: 'accessory', rarity: 'SR', atk: 15, hp: 150, spd: 0, desc: 'å—åˆ°ç¥ç¦çš„è­·èº«ç¬¦', icon: 'ğŸ§¿' },
            { id: 'eq_ac_ssr1', name: 'çš‡å®¤å¾½ç« ', type: 'accessory', rarity: 'SSR', atk: 50, hp: 400, spd: 5, desc: 'è±¡å¾µç„¡ä¸Šæ¬ŠåŠ›çš„é£¾å“', icon: 'ğŸ‘‘' },
            { id: 'eq_ac_ssr2', name: 'æ™‚å…‰æ²™æ¼', type: 'accessory', rarity: 'SSR', atk: 10, hp: 100, spd: 20, cdRed: 1, desc: 'æµå‹•è‘—æ™‚é–“é­”æ³•çš„æ²™æ¼ï¼Œèƒ½åŠ é€ŸæŠ€èƒ½å†·å»ã€‚', icon: 'â³' },
        ];

        // --- Expanded to 5 Enemies per Stage ---
        const STORY_CHAPTERS = [
            { id: 's1', name: 'åºç« ï¼šç•°è®Šçš„é–‹ç«¯', desc: 'æ˜Ÿç•Œå„è™•çªç„¶å‡ºç¾äº†é­”ç‰©ç‹‚æš´åŒ–çš„ç¾è±¡ï¼Œé¦–å…ˆå‰å¾€é™„è¿‘çš„æ£®æ—èª¿æŸ¥å²èŠå§†ç•°è®Šçš„åŸå› ã€‚', recLv: 1, enemies: ['easy', 'easy', 'easy', 'easy', 'easy_boss'], exp: 100, gems: 50, color: 'green', type: 'story' },
            { id: 's1_2', name: 'ç¬¬ä¸€ç« ï¼šè¿·éœ§æ£®æ—', desc: 'æ£®æ—æ·±è™•çš„éœ§æ°£è¶Šä¾†è¶Šæ¿ƒï¼Œä¼¼ä¹æœ‰æ›´å…‡çŒ›çš„é‡ç¸æ½›ä¼åœ¨é™°å½±ä¹‹ä¸­ã€‚', recLv: 3, enemies: ['easy', 'easy', 'wolf', 'wolf', 'wolf'], exp: 150, gems: 60, color: 'emerald', type: 'story' },
            { id: 's2', name: 'ç¬¬äºŒç« ï¼šç¶ çš®çš„å¨è„…', desc: 'èª¿æŸ¥é€”ä¸­ç™¼ç¾äº†å“¥å¸ƒæ—çš„ç‡Ÿåœ°ï¼Œç‰ å€‘ä¼¼ä¹åœ¨ç­–åŠƒè‘—æ”»æ“Šæ‘èŠï¼Œå¿…é ˆå…ˆç™¼åˆ¶äººã€‚', recLv: 5, enemies: ['easy_strong', 'easy_strong', 'easy_strong', 'easy_strong', 'easy_boss'], exp: 200, gems: 80, color: 'teal', type: 'story' },
            { id: 's2_2', name: 'ç¬¬ä¸‰ç« ï¼šå»¢æ£„ç¤¦å‘', desc: 'å“¥å¸ƒæ—ä¼¼ä¹å¾é€™åº§å»¢æ£„ç¤¦å‘ä¸­æŒ–æ˜å‡ºäº†æŸç¨®é»‘æš—ç‰©è³ªï¼Œå¿…é ˆæ·±å…¥èª¿æŸ¥ã€‚', recLv: 8, enemies: ['easy_strong', 'easy_strong', 'easy_strong', 'normal', 'normal'], exp: 280, gems: 90, color: 'cyan', type: 'story' },
            { id: 's3', name: 'ç¬¬å››ç« ï¼šç‹¼åšä¹‹å¤œ', desc: 'è¿½è¹¤é­”åŠ›æ®˜ç•™ä¾†åˆ°äº†æ²¼æ¾¤ï¼Œé€™è£¡çš„ç‹¼ç¾¤å—åˆ°é»‘æš—æ°£æ¯å½±éŸ¿è®Šå¾—ç•°å¸¸å…‡çŒ›ã€‚', recLv: 11, enemies: ['wolf', 'wolf', 'wolf', 'wolf', 'wolf_boss'], exp: 350, gems: 100, color: 'blue', type: 'story' },
            { id: 's4', name: 'ç¬¬äº”ç« ï¼šäº¡è€…ä½èª', desc: 'å¤å ¡ä¸­å‚³ä¾†äº†ä¸è©²å­˜åœ¨çš„è²éŸ¿ï¼Œä¼¼ä¹æœ‰æ­»éˆæ³•å¸«åœ¨é€²è¡Œç¦å¿Œçš„å„€å¼ã€‚', recLv: 15, enemies: ['normal', 'normal', 'normal', 'normal', 'normal_boss'], exp: 500, gems: 150, color: 'indigo', type: 'story' },
            { id: 's4_2', name: 'ç¬¬å…­ç« ï¼šé®®è¡€ç¥­å£‡', desc: 'å„€å¼å·²ç¶“å®Œæˆäº†ä¸€åŠï¼Œç©ºæ°£ä¸­ç€°æ¼«è‘—è¡€è…¥å‘³ï¼Œæ›´å¼·å¤§çš„ä¸æ­»ç”Ÿç‰©æ­£åœ¨ç”¦é†’ã€‚', recLv: 18, enemies: ['normal_strong', 'normal_strong', 'normal_strong', 'normal', 'normal_boss'], exp: 650, gems: 180, color: 'violet', type: 'story' },
            { id: 's5', name: 'ç¬¬ä¸ƒç« ï¼šè »è’æˆ°æ­Œ', desc: 'ç¸äººéƒ¨è½é›†çµäº†å¤§è»ï¼Œå¿…é ˆæ“Šæ•—ä»–å€‘çš„é…‹é•·ä»¥é˜»æ­¢æˆ°çˆ­çˆ†ç™¼ã€‚', recLv: 22, enemies: ['orc', 'orc', 'orc', 'orc', 'orc_boss'], exp: 800, gems: 200, color: 'purple', type: 'story' },
            { id: 's5_2', name: 'ç¬¬å…«ç« ï¼šé‹¼éµé˜²ç·š', desc: 'ç¸äººç«Ÿç„¶èˆ‡é»‘æš—é¨å£«çµç›Ÿäº†ï¼Œå‰æ–¹æ˜¯ä»–å€‘å…±åŒæ§‹ç¯‰çš„å …å›ºé˜²ç·šã€‚', recLv: 26, enemies: ['orc', 'orc', 'hard', 'hard', 'orc_boss'], exp: 1000, gems: 250, color: 'fuchsia', type: 'story' },
            { id: 's6', name: 'ç¬¬ä¹ç« ï¼šæ·±åŸ‹çš„ç§˜å¯†', desc: 'ç¤¦å‘æ·±è™•æŒ–æ˜å‡ºäº†æœªçŸ¥çš„å¤ä»£éºè·¡ï¼Œå®ˆè­·éºè·¡çš„æ€ªç‰©ç”¦é†’äº†ã€‚', recLv: 30, enemies: ['normal_strong', 'normal_strong', 'normal_strong', 'hard', 'hard'], exp: 1200, gems: 300, color: 'pink', type: 'story' },
            { id: 's6_2', name: 'ç¬¬åç« ï¼šç‡ƒç‡’å¹³åŸ', desc: 'é€šå¾€å·¨é¾å·¢ç©´çš„é“è·¯è¢«çƒˆç«è¦†è“‹ï¼Œæ¯ä¸€æ­¥éƒ½å¦‚åŒè¡Œèµ°åœ¨ç…‰ç„ä¹‹ä¸­ã€‚', recLv: 35, enemies: ['hard', 'hard', 'hard', 'hard', 'hard'], exp: 1600, gems: 400, color: 'rose', type: 'story' },
            { id: 's7', name: 'ç¬¬åä¸€ç« ï¼šå·¨é¾ç”¦é†’', desc: 'å¼·å¤§çš„é­”åŠ›æ³¢å‹•æºè‡ªæ–¼æ²‰ç¡çš„æ··æ²Œé­”é¾ï¼Œç‚ºäº†æ˜Ÿç•Œçš„å’Œå¹³ï¼Œå¿…é ˆè¨ä¼ç‰ ã€‚', recLv: 40, enemies: ['hard', 'hard', 'hard', 'hard', 'hard_boss'], exp: 2000, gems: 500, color: 'red', type: 'story' },
            { id: 's7_2', name: 'ç¬¬åäºŒç« ï¼šæ·±æ·µä¹‹é–€', desc: 'å·¨é¾å€’ä¸‹å¾Œï¼ŒçœŸæ­£çš„çµ•æœ›ä¹‹é–€æ‰“é–‹äº†ï¼Œæ·±æ·µçš„æ°£æ¯æ­£åœ¨åå™¬ä¸€åˆ‡ã€‚', recLv: 45, enemies: ['hard_boss', 'hard_boss', 'void', 'void', 'void'], exp: 3500, gems: 800, color: 'gray', type: 'story' },
            { id: 's8', name: 'çµ‚ç« ï¼šæ·±æ·µå‡è¦–', desc: 'ä¸€åˆ‡çš„å…ƒå…‡å°±åœ¨æ·±æ·µçš„ç›¡é ­ï¼Œæº–å‚™å¥½è¿æ¥æœ€çµ‚çš„å‘½é‹ä¹‹æˆ°äº†å—ï¼Ÿ', recLv: 50, enemies: ['void', 'void', 'void', 'void_boss', 'hard_boss'], exp: 5000, gems: 1000, color: 'slate', type: 'story' },
            // Post-Game Chapters
            { id: 's9', name: 'å¤–å‚³ï¼šè™›ç©ºå…¥ä¾µ', desc: 'é›–ç„¶æ“Šé€€äº†æ·±æ·µï¼Œä½†ç©ºé–“è£‚ç¸«ä¸­æ¹§å‡ºäº†æ›´è©­ç•°çš„è™›ç©ºç”Ÿç‰©ï¼Œç‰ å€‘æ­£åœ¨åå™¬ç¾å¯¦ã€‚', recLv: 65, enemies: ['void', 'void', 'void', 'void', 'void_boss'], exp: 8000, gems: 1500, color: 'indigo', type: 'story' },
            { id: 's10', name: 'å¤–å‚³ï¼šæ³°å¦éºè·¡', desc: 'ç‚ºäº†å°‹æ±‚å°æŠ—è™›ç©ºçš„åŠ›é‡ï¼Œä½ å‰å¾€äº†å‚³èªªä¸­çš„æ³°å¦éºè·¡ï¼Œé‚£è£¡çš„å®ˆè¡›è€…ä¾ç„¶åœ¨é‹ä½œã€‚', recLv: 80, enemies: ['ancient', 'ancient', 'ancient', 'ancient', 'ancient_boss'], exp: 15000, gems: 2000, color: 'yellow', type: 'story' },
            { id: 's11', name: 'æœ€çµ‚æˆ°ï¼šè«¸ç¥é»ƒæ˜', desc: 'å‡¡äººçš„åŠ›é‡å·²è§¸åŠäº†ç¦å¿Œé ˜åŸŸï¼ŒèˆŠæ—¥çš„ç¥ç¥‡é™ä¸‹ç¥ç½°ï¼Œç‚ºäº†ç”Ÿå­˜ï¼Œä½ å¿…é ˆå¼’ç¥ã€‚', recLv: 99, enemies: ['god', 'god', 'god', 'god', 'god_boss'], exp: 50000, gems: 5000, color: 'red', type: 'story' },
        ];

        const RESOURCE_STAGES = [
            { id: 'r_exp1', name: 'ç¶“é©—ç‰¹è¨“ (åˆç´š)', desc: 'é©åˆæ–°æ‰‹çš„è¨“ç·´å ´æ‰€ï¼Œå¯ç²å¾—å¤§é‡ç¶“é©—å€¼ã€‚', recLv: 5, enemies: ['easy', 'easy', 'easy', 'easy', 'easy'], exp: 800, gems: 10, color: 'blue', type: 'resource' },
            { id: 'r_exp2', name: 'ç¶“é©—ç‰¹è¨“ (ä¸­ç´š)', desc: 'é‡å°æœ‰ç¶“é©—çš„å†’éšªè€…ï¼Œèƒ½å¿«é€Ÿç´¯ç©ç¶“é©—ã€‚', recLv: 20, enemies: ['normal', 'normal', 'normal', 'normal', 'normal'], exp: 3000, gems: 20, color: 'indigo', type: 'resource' },
            { id: 'r_exp3', name: 'ç¶“é©—ç‰¹è¨“ (é«˜ç´š)', desc: 'åœ°ç„èˆ¬çš„è©¦ç…‰ï¼Œä½†å›å ±ä¹Ÿæ¥µç‚ºè±åšã€‚', recLv: 40, enemies: ['hard', 'hard', 'hard', 'hard', 'hard'], exp: 10000, gems: 50, color: 'violet', type: 'resource' },
            { id: 'r_eq1', name: 'å¯¶è—çµäºº (åˆç´š)', desc: 'å‚³èªªä¸­åŸ‹è—è‘—ç”Ÿé½æ­¦å™¨çš„éºè·¡ã€‚', recLv: 10, enemies: ['easy_strong', 'easy_strong', 'easy_strong', 'easy_strong', 'easy_boss'], exp: 200, gems: 20, color: 'orange', type: 'resource', dropRate: 0.5 },
            { id: 'r_eq2', name: 'å¯¶è—çµäºº (é«˜ç´š)', desc: 'å¤ä»£è‹±é›„éºç•™ä¸‹ä¾†çš„å¯¶åº«ï¼Œå®ˆè¡›æ£®åš´ã€‚', recLv: 30, enemies: ['orc', 'orc', 'orc', 'orc', 'orc_boss'], exp: 1000, gems: 50, color: 'yellow', type: 'resource', dropRate: 0.8 },
        ];

        const ALL_STAGES = [...STORY_CHAPTERS, ...RESOURCE_STAGES];

        // ADDED PASSIVE TO ENEMIES AND SPD
        const ENEMIES_DATA = {
            'easy': { name: 'å²èŠå§†', icon: 'ğŸŸ¢', hp: 60, atk: 10, spd: 80, seed: 'Slime', element: 'water', skills: [{ name: 'æ’æ“Š', type: 'dmg', val: 1.2, prob: 0.3 }] },
            'easy_strong': { name: 'å“¥å¸ƒæ—', icon: 'ğŸ‘º', hp: 100, atk: 18, spd: 95, seed: 'Goblin', element: 'earth', passive: { type: 'team_atk', val: 0.05, name: 'æˆ°å¼' }, skills: [{ name: 'å·è¥²', type: 'dmg', val: 1.3, prob: 0.3 }] },
            'easy_boss': { 
                name: 'å²èŠå§†ç‹', icon: 'ğŸ‘‘', hp: 250, atk: 25, spd: 85, isBoss:true, seed: 'KingSlime', element: 'water',
                passive: { type: 'team_def', val: 0.1, name: 'é»æ¶²è­·ç”²' },
                skills: [
                    { name: 'é»æ¶²å™´æ¿º', type: 'aoe', val: 0.8, prob: 0.3, status: {type:'poison', val:0.2, dur:2, name:'ä¸­æ¯’'} },
                    { name: 'è‡ªæˆ‘å†ç”Ÿ', type: 'heal', val: 0.3, prob: 0.2 }
                ]
            },
            'wolf': { name: 'è’åŸç‹¼', icon: 'ğŸº', hp: 150, atk: 25, spd: 120, seed: 'Wolf', element: 'wind', passive: { type: 'crit_rate', val: 0.1, name: 'é‡æ€§' }, skills: [{ name: 'æ’•å’¬', type: 'dmg', val: 1.4, prob: 0.4 }] },
            'wolf_boss': { name: 'ç‹¼ç‹', icon: 'ğŸŒ•', hp: 400, atk: 40, spd: 130, isBoss:true, seed: 'Werewolf', element: 'wind', passive: { type: 'team_atk', val: 0.1, name: 'ç‹¼ç¾¤é ˜è¢–' }, skills: [{ name: 'ç¾¤ç‹¼å¬å–š', type: 'dmg', val: 1.5, prob: 0.3 }] },
            'normal': { name: 'éª·é«å…µ', icon: 'ğŸ’€', hp: 220, atk: 35, spd: 85, seed: 'Skeleton', element: 'dark', skills: [{ name: 'é‡æ–¬', type: 'dmg', val: 1.5, prob: 0.3 }] },
            'normal_strong': { name: 'é£Ÿå±é¬¼', icon: 'ğŸ§Ÿ', hp: 350, atk: 45, spd: 90, seed: 'Ghoul', element: 'dark', passive: { type: 'enemy_debuff_def', val: 0.05, name: 'è…è•å…‰ç’°' }, skills: [{ name: 'è…è•', type: 'dmg', val: 1.2, prob: 0.5, status: {type:'poison', val:0.1, dur:3, name:'è…è•'} }] },
            'normal_boss': { 
                name: 'å¸è¡€é¬¼', icon: 'ğŸ§›', hp: 600, atk: 60, spd: 140, isBoss:true, seed: 'Vampire', element: 'dark',
                passive: { type: 'lifesteal_boost', val: 0.2, name: 'é®®è¡€æ¸´æ±‚' },
                skills: [
                    { name: 'é®®è¡€æ±²å–', type: 'lifesteal', val: 1.2, prob: 0.3 },
                    { name: 'è™è ç¾¤è¥²', type: 'aoe', val: 0.7, prob: 0.3 }
                ]
            },
            'orc': { name: 'åŠç¸äºº', icon: 'ğŸ‘¹', hp: 300, atk: 40, spd: 70, seed: 'Orc', element: 'earth', passive: { type: 'self_hp', val: 0.1, name: 'è »åŠ›é«”é­„' }, skills: [{ name: 'è »åŠ›', type: 'dmg', val: 1.4, prob: 0.3 }] },
            'orc_boss': { name: 'ç¸äººé…‹é•·', icon: 'ğŸ‘º', hp: 800, atk: 70, spd: 75, isBoss:true, seed: 'OrcChieftain', element: 'earth', passive: { type: 'team_atk', val: 0.15, name: 'æˆ°æ­Œ' }, skills: [{ name: 'æ—‹é¢¨æ–¬', type: 'aoe', val: 0.9, prob: 0.4 }] },
            'hard': { name: 'æš—é»‘é¨å£«', icon: 'ğŸ›¡ï¸', hp: 800, atk: 80, spd: 90, seed: 'DarkKnight', element: 'dark', passive: { type: 'self_def', val: 0.2, name: 'æš—é»‘é§ç”²' }, skills: [{ name: 'æš—é»‘æ–¬', type: 'dmg', val: 1.6, prob: 0.4 }] },
            'hard_boss': { 
                name: 'æ··æ²Œé­”é¾', icon: 'ğŸ‰', hp: 2500, atk: 200, spd: 110, isBoss:true, seed: 'ChaosDragon', element: 'fire',
                passive: { type: 'enemy_debuff_atk', val: 0.1, name: 'é¾å¨' },
                skills: [
                    { name: 'æ¯€æ»…åæ¯', type: 'aoe', val: 1.5, prob: 0.3 },
                    { name: 'é¾ä¹‹å’†å“®', type: 'aoe', val: 0.8, prob: 0.4, status: {type:'stun', chance:0.5, dur:1, name:'ææ‡¼'} } 
                ]
            },
            'void': { name: 'è™›ç©ºè¡Œè€…', icon: 'ğŸ‘¾', hp: 1500, atk: 120, spd: 130, seed: 'VoidWalker', element: 'dark', passive: { type: 'dodge', val: 0.15, name: 'è™›ç©ºæŠ˜å°„' }, skills: [{ name: 'ç‰©è³ªè§£æ§‹', type: 'dmg', val: 1.5, prob: 0.4 }] },
            'void_boss': { 
                name: 'è™›ç©ºé ˜ä¸»', icon: 'ğŸ‘¿', hp: 5000, atk: 300, spd: 150, isBoss:true, seed: 'VoidLord', element: 'dark',
                passive: { type: 'enemy_debuff_hp', val: 0.1, name: 'è™›ç©ºä¾µè•' },
                skills: [
                    { name: 'é»‘æ´åç¸®', type: 'aoe', val: 1.4, prob: 0.3, status: {type:'stun', chance:0.6, dur:1, name:'æ™‚ç©ºå‡çµ'} },
                    { name: 'è™›ç©ºæ±²å–', type: 'lifesteal', val: 2.0, prob: 0.4 }
                ]
            },
            'ancient': { name: 'éºè·¡å®ˆè¡›', icon: 'ğŸ—¿', hp: 3000, atk: 150, spd: 60, seed: 'Golem', element: 'earth', passive: { type: 'self_def', val: 0.3, name: 'å²©çŸ³çš®è†š' }, skills: [{ name: 'é‡æ‹³', type: 'dmg', val: 1.6, prob: 0.3, status: {type:'stun', chance:0.3, dur:1, name:'æšˆçœ©'} }] },
            'ancient_boss': { 
                name: 'æ³°å¦å·¨äºº', icon: 'ğŸŒ‹', hp: 10000, atk: 450, spd: 50, isBoss:true, seed: 'Titan', element: 'earth',
                passive: { type: 'team_def', val: 0.2, name: 'å¤§åœ°å®ˆè­·' },
                skills: [
                    { name: 'å¤§åœ°å´©è£‚', type: 'aoe', val: 1.8, prob: 0.4 },
                    { name: 'çµ•å°é˜²ç¦¦', type: 'heal', val: 0.1, prob: 0.2, status: {type:'def_up', val:0.8, dur:3, name:'æ™¶é«”åŒ–'} }
                ]
            },
            'god': { name: 'å¢®è½å¤©ä½¿', icon: 'ğŸª½', hp: 4000, atk: 200, spd: 160, seed: 'FallenAngel', element: 'light', passive: { type: 'self_atk', val: 0.2, name: 'ç¥åŠ›' }, skills: [{ name: 'è–ç„°å¯©åˆ¤', type: 'dmg', val: 2.0, prob: 0.4, status: {type:'burn', val:0.3, dur:3, name:'è–ç«'} }] },
            'god_boss': { 
                name: 'ç ´å£ç¥', icon: 'âš¡', hp: 25000, atk: 800, spd: 200, isBoss:true, seed: 'GodOfDestruction', element: 'light',
                passive: { type: 'enemy_debuff_all', val: 0.1, name: 'ç¥ä¹‹é ˜åŸŸ' },
                skills: [
                    { name: 'æ»…ä¸–å…‰è¼', type: 'aoe', val: 3.0, prob: 0.2, status: {type:'burn', val:0.5, dur:5, name:'æ¯€æ»…'} },
                    { name: 'ç¥ä¹‹å¨å£“', type: 'aoe', val: 1.0, prob: 0.5, status: {type:'stun', chance:0.8, dur:1, name:'å¨å£“'} }
                ]
            }
        };

        // --- Helper: Images ---
        function getCharImage(char, isEnemy=false) {
            if(char.customImg) return char.customImg;
            if(isEnemy) return `https://robohash.org/${encodeURIComponent(char.seed||char.name)}.png?set=set2&size=200x200`;
            return `https://api.dicebear.com/9.x/lorelei/svg?seed=${encodeURIComponent(char.seed||char.name)}&backgroundColor=${char.bg||'transparent'}`;
        }

        // --- State ---
        let gameState = { gems: 1500, globalExp: 0, inventory: [], equipment: [], team: [], lastLogin: Date.now() };
        let battleState = { active: false, players: [], enemies: [], turn: 0, turnCount: 1, difficulty: 0, currentPlayerIndex: 0, gameOver: false, selectedSkillIndex: 0, isAuto: false, roundOrder: [], roundIndex: 0 };
        let selectedCharIndex = -1; 
        let currentEquipSlotType = null;
        let currentCampaignTab = 'story'; // 'story' or 'resource'

        window.onload = function() { 
            try { 
                loadGame(); 
                syncData(); 
                if(gameState.inventory.length===0){addCharacter('r1');addCharacter('r2');gameState.team=[0,1];} 
                updateUI(); 
                switchCampaignTab('story');
                renderLobby();
                switchView('lobby'); 
            } catch(e) { 
                console.error("Critical Init Error:", e);
                // alert("éŠæˆ²åˆå§‹åŒ–å¤±æ•—ï¼Œå°‡é‡ç½®å­˜æª”ã€‚");
                localStorage.removeItem('starfallLegendsSave'); 
                location.reload(); 
            }
        };

        // --- Logic ---
        function saveGame() { localStorage.setItem('starfallLegendsSave', JSON.stringify(gameState)); }
        function loadGame() { const s = localStorage.getItem('starfallLegendsSave'); if(s) gameState = JSON.parse(s); }
        function resetData() { if(confirm('ç¢ºå®šé‡ç½®ï¼Ÿæ‰€æœ‰é€²åº¦å°‡æœƒæ¶ˆå¤±ï¼')) { localStorage.removeItem('starfallLegendsSave'); location.reload(); } }
        
        // Export/Import Logic
        function openSettings() { UI.showFlex('settings-overlay'); }
        function closeSettings() { UI.hideFlex('settings-overlay'); }
        
        function exportSave() {
            const saveStr = JSON.stringify(gameState);
            const encoded = btoa(encodeURIComponent(saveStr)); // Simple encoding
            const area = document.getElementById('export-area');
            const textarea = document.getElementById('save-code-output');
            if(area && textarea) {
                area.classList.remove('hidden');
                textarea.value = encoded;
            }
        }
        
        function copySaveCode() {
            const textarea = document.getElementById('save-code-output');
            if(textarea) {
                textarea.select();
                document.execCommand('copy');
                alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            }
        }
        
        function importSave() {
            const input = prompt("è«‹è²¼ä¸Šæ‚¨çš„å­˜æª”ä»£ç¢¼ï¼š");
            if(input) {
                try {
                    const decoded = decodeURIComponent(atob(input));
                    const data = JSON.parse(decoded);
                    if(data && data.gems !== undefined && data.inventory) {
                        gameState = data;
                        saveGame();
                        alert('åŒ¯å…¥æˆåŠŸï¼éŠæˆ²å°‡é‡æ–°è¼‰å…¥ã€‚');
                        location.reload();
                    } else {
                        throw new Error("Invalid format");
                    }
                } catch(e) {
                    alert('åŒ¯å…¥å¤±æ•—ï¼šä»£ç¢¼æ ¼å¼éŒ¯èª¤ã€‚');
                    console.error(e);
                }
            }
        }

        function syncData() {
            if(!gameState.inventory) gameState.inventory = [];
            if(!gameState.equipment) gameState.equipment = [];
            if(!gameState.team) gameState.team = [];
            
            gameState.inventory = gameState.inventory.filter(char => {
                const exists = CHARACTERS_DB.some(c => c.id === char.baseId);
                return exists;
            });

            gameState.inventory.forEach(char => {
                const base = CHARACTERS_DB.find(c => c.id === char.baseId);
                if (base) {
                    char.skills = base.skills;
                    char.seed = base.seed;
                    char.bg = base.bg;
                    char.name = base.name;
                    char.icon = base.icon;
                    char.rarity = base.rarity;
                    char.desc = base.desc;
                    char.element = base.element; 
                    char.type = base.type; 
                    char.passive = base.passive; // SYNC PASSIVE
                    // SYNC SPD if not present
                    if (char.spd === undefined) char.spd = base.spd;
                    
                    if (char.limitBreak === undefined) char.limitBreak = 0;
                    if (char.duplicates === undefined) char.duplicates = 0;
                    if (char.equipment === undefined) char.equipment = { weapon: null, armor: null, accessory: null };
                    if (char.status === undefined) char.status = [];
                }
            });
            gameState.team = gameState.team.filter(idx => gameState.inventory[idx]);
            saveGame();
        }

        function addCharacter(id) {
            const existingIndex = gameState.inventory.findIndex(c => c.baseId === id);
            const charBase = CHARACTERS_DB.find(c => c.id === id);
            
            if (existingIndex !== -1) {
                const char = gameState.inventory[existingIndex];
                if ((char.limitBreak || 0) >= 4) {
                    const refund = charBase.rarity==='SSR'?3000 : (charBase.rarity==='SR'?1000 : 300);
                    addGems(refund);
                    return { isNew: false, char: char, isMax: true, refund: refund };
                } else {
                    char.duplicates = (char.duplicates || 0) + 1;
                    saveGame();
                    return { isNew: false, char: char, isDupe: true };
                }
            } else {
                const newChar = { 
                    instanceId: Date.now()+Math.random(), baseId: id, ...charBase, 
                    level: 1, exp: 0, hp: charBase.hp, atk: charBase.atk, 
                    limitBreak: 0, duplicates: 0,
                    equipment: { weapon: null, armor: null, accessory: null },
                    status: []
                };
                gameState.inventory.push(newChar);
                saveGame();
                return { isNew: true, char: newChar };
            }
        }

        function addEquipment(baseId) {
            const base = EQUIPMENT_DB.find(e => e.id === baseId);
            const newEquip = { instanceId: Date.now() + Math.random(), baseId: baseId, ...base, isEquipped: false };
            gameState.equipment.push(newEquip);
            saveGame();
            return newEquip;
        }

        function addGems(amount) { gameState.gems += amount; updateUI(); saveGame(); }
        function addExp(amount) { gameState.globalExp = (gameState.globalExp || 0) + amount; updateUI(); saveGame(); }
        
        function updateUI() {
            if(!gameState) return;
            UI.setText('gem-display', gameState.gems);
            UI.setText('exp-display', gameState.globalExp || 0);
        }

        // ... (View switching, Gacha logic remain same)
        function switchView(view) {
            SoundManager.play('click');
            ['lobby', 'adventure','team','gacha','chars','battle','gallery'].forEach(v => {
                UI.hide(`view-${v}`);
            });
            UI.show(`view-${view}`);
            
            if(view === 'lobby') renderLobby();
            if(view === 'team') renderTeamView();
            if(view === 'chars') renderCharsList();
            if(view === 'gallery') renderGallery();
            if(view === 'adventure') renderCampaigns(); 

            if (view === 'lobby') {
                UI.show('main-nav');
            } else {
                UI.hide('main-nav');
            }
        }
        
        function renderLobby() { }

        function pullGacha(count) {
            const cost = count * 100;
            if (gameState.gems < cost) { alert('å¯¶çŸ³ä¸è¶³ï¼'); return; }
            
            gameState.gems -= cost;
            updateUI();
            saveGame();

            const results = [];
            let maxRarityVal = 0; 

            for (let i = 0; i < count; i++) {
                let rand = Math.random() * 100;
                let rarity = 'R';
                if (i === 9 && count === 10 && results.every(r => r.char.rarity === 'R')) {
                     if (rand > 30) rand = Math.random() * 30; 
                }

                if (rand < 5) rarity = 'SSR';
                else if (rand < 30) rarity = 'SR';
                
                const pool = CHARACTERS_DB.filter(c => c.rarity === rarity);
                const charBase = pool[Math.floor(Math.random() * pool.length)];
                
                const result = addCharacter(charBase.id);
                results.push(result);

                let rVal = rarity === 'SSR' ? 2 : (rarity === 'SR' ? 1 : 0);
                if (rVal > maxRarityVal) maxRarityVal = rVal;
            }

            const animType = maxRarityVal === 2 ? 'SSR' : (maxRarityVal === 1 ? 'SR' : 'R');
            playGachaAnimation(animType, () => {
                showGachaResults(results);
            });
        }

        function playGachaAnimation(type, callback) {
            const overlay = document.getElementById('ssr-summon-animation');
            const flash = document.getElementById('summon-flash');
            if(overlay) {
                overlay.classList.remove('hidden');
                overlay.className = `fixed inset-0 z-[70] bg-black flex flex-col items-center justify-center anim-${type}`;
            }
            
            if(type === 'SSR') SoundManager.play('ssr_anim');
            else SoundManager.play('gacha');

            setTimeout(() => {
                if(flash) flash.classList.remove('hidden');
                setTimeout(() => {
                    if(overlay) {
                        overlay.classList.add('hidden');
                        overlay.classList.remove(`anim-${type}`);
                    }
                    if(flash) flash.classList.add('hidden');
                    callback();
                }, 500); 
            }, type === 'SSR' ? 2800 : (type === 'SR' ? 2300 : 1800)); 
        }

        function showGachaResults(results) {
            const container = document.getElementById('gacha-cards-container');
            if(container) {
                container.innerHTML = '';
                
                // Adjust layout based on count
                if (results.length === 1) {
                    container.className = "flex justify-center items-center w-full mb-12";
                } else {
                    container.className = "grid grid-cols-2 md:grid-cols-5 gap-4 mb-12 w-full";
                }

                results.forEach((res, index) => {
                    const char = res.char;
                    const div = createCharCard(char, false, null);
                    
                    // Staggered Animation
                    div.style.animation = `pop-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) ${index * 0.1}s backwards`;

                    if (res.isNew) {
                        const badge = document.createElement('div');
                        badge.className = "absolute top-2 -left-2 bg-red-600 text-white text-sm px-3 py-1 rounded-r shadow-lg font-black z-20 animate-bounce border-2 border-white transform -rotate-12";
                        badge.innerText = "NEW!";
                        div.appendChild(badge);
                    } else {
                        const badge = document.createElement('div');
                        badge.className = "absolute bottom-20 left-0 w-full text-center text-[10px] text-yellow-300 font-bold z-20 shadow-black drop-shadow-md bg-black/50 py-1";
                        badge.innerText = res.isMax ? `å·²æ»¿çª (è¿”é‚„ ${res.refund} é‘½)` : "çªç ´ç¢ç‰‡ +1";
                        div.appendChild(badge);
                    }
                    container.appendChild(div);
                });
            }
            UI.showFlex('gacha-result');
        }

        function closeGachaResult() {
            SoundManager.play('click');
            UI.hideFlex('gacha-result');
        }

        function renderCharsList() {
            const container = document.getElementById('chars-list-container');
            if(!container) return;
            container.innerHTML = '';
            const list = [...gameState.inventory].map((c,i)=>({c,i})).sort((a,b) => b.c.level - a.c.level);

            list.forEach(item => {
                const char = item.c;
                const div = createCharCard(char, false, () => openCharDetail(item.i));
                const maxLvl = (char.limitBreak || 0) * 20 + 20;
                const canEvolve = char.level >= maxLvl && char.duplicates > 0 && char.limitBreak < 4;
                const canLevel = char.level < maxLvl && gameState.globalExp >= 100;
                if (canEvolve || canLevel) {
                    const dot = document.createElement('div');
                    dot.className = "absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border border-white z-40";
                    div.appendChild(dot);
                }
                container.appendChild(div);
            });
        }

        function renderGallery() {
            const container = document.getElementById('gallery-list-container');
            const progress = document.getElementById('gallery-progress');
            if(!container) return;
            container.innerHTML = '';
            
            const total = CHARACTERS_DB.length;
            let collected = 0;

            const sortedDB = [...CHARACTERS_DB].sort((a, b) => {
                const rW = { 'SSR': 3, 'SR': 2, 'R': 1 };
                return rW[b.rarity] - rW[a.rarity];
            });

            sortedDB.forEach(baseChar => {
                const ownedChar = gameState.inventory.find(c => c.baseId === baseChar.id);
                const isOwned = !!ownedChar;
                if (isOwned) collected++;

                const div = document.createElement('div');
                const imgUrl = getCharImage(baseChar);
                
                const grayscale = isOwned ? '' : 'grayscale opacity-60';
                const rarityColor = isOwned ? `text-${baseChar.rarity}` : 'text-gray-500';
                
                div.className = `relative rounded-xl overflow-hidden border-2 border-gray-700 bg-gray-800 w-full h-48 cursor-pointer transform hover:scale-105 transition-all`;
                
                div.innerHTML = `
                    <div class="absolute inset-0 bg-black/40 z-10"></div>
                    <img src="${imgUrl}" class="w-full h-full object-cover ${grayscale}">
                    
                    ${!isOwned ? '<div class="absolute inset-0 flex items-center justify-center z-20"><i class="fas fa-lock text-3xl text-gray-400 opacity-80"></i></div>' : ''}
                    
                    <div class="absolute bottom-0 w-full p-2 bg-gradient-to-t from-black to-transparent z-20">
                         <div class="flex justify-between items-end">
                            <span class="text-xs font-bold text-white truncate">${isOwned ? baseChar.name : '???'}</span>
                            <span class="text-[10px] font-bold ${rarityColor}">${baseChar.rarity}</span>
                         </div>
                    </div>
                `;

                div.onclick = () => {
                    SoundManager.play('click');
                    if (isOwned) {
                        const idx = gameState.inventory.findIndex(c => c.baseId === baseChar.id);
                        openCharDetail(idx, true); 
                    } else {
                        openGalleryDetail(baseChar);
                    }
                };

                container.appendChild(div);
            });

            if(progress) progress.innerText = `${collected}/${total}`;
        }

        function openGalleryDetail(baseChar) {
            UI.setText('detail-name', baseChar.name);
            UI.setText('detail-rarity', baseChar.rarity);
            
            const rarityEl = document.getElementById('detail-rarity');
            if(rarityEl) rarityEl.className = `text-sm font-bold mb-2 text-${baseChar.rarity}`;
            
            UI.setText('detail-class', baseChar.desc || 'Unknown Class');
            UI.setSrc('detail-img', getCharImage(baseChar));
            
            UI.setText('detail-hp', baseChar.hp);
            UI.setText('detail-atk', baseChar.atk);
            UI.setText('detail-spd', baseChar.spd || 100); // Show SPD in gallery

            // Populate Element/Type in Gallery
            const elemContainer = document.getElementById('detail-elements');
            if(elemContainer) {
                 const elName = {fire:'ç«', water:'æ°´', wind:'é¢¨', earth:'åœ°', light:'å…‰', dark:'æš—'}[baseChar.element];
                 const elColor = {fire:'bg-red-600', water:'bg-blue-600', wind:'bg-green-600', earth:'bg-yellow-600', light:'bg-yellow-300 text-black', dark:'bg-gray-700'}[baseChar.element];
                 const typeName = {phys:'ç‰©ç†', mag:'é­”æ³•'}[baseChar.type] || 'ç‰©ç†';
                 
                 elemContainer.innerHTML = `
                    <span class="${elColor} px-2 py-1 rounded border border-white/20 font-bold">${elName}</span>
                    <span class="bg-gray-600 px-2 py-1 rounded border border-white/20">${typeName}</span>
                 `;
            }

            UI.setHtml('detail-story', '<span class="text-gray-500"><i class="fas fa-lock mr-2"></i> ??? (è§£é–è§’è‰²ä»¥æŸ¥çœ‹æ•…äº‹)</span>');
            
            const passiveInfo = document.getElementById('detail-passive-info');
            if (passiveInfo && baseChar.passive) {
                 passiveInfo.innerHTML = `
                    <div class="font-bold text-white mb-1">${baseChar.passive.name}</div>
                    <div class="text-indigo-200 text-xs">${baseChar.passive.desc}</div>
                `;
            }
            
            const skillList = document.getElementById('detail-skills-list');
            if(skillList) {
                skillList.innerHTML = '';
                baseChar.skills.forEach(skill => {
                    const row = document.createElement('div');
                    row.className = 'flex justify-between items-center bg-black/30 p-2 rounded';
                    let typeIcon = skill.type === 'heal' ? 'ğŸ’š' : (skill.type === 'aoe' ? 'ğŸ’¥' : 'âš”ï¸');
                    let desc = "";
                    if(skill.type === 'dmg') desc = `å–®é«” ${Math.round(skill.val*100)}% å‚·å®³`;
                    else if(skill.type === 'aoe') desc = `å…¨é«” ${Math.round(skill.val*100)}% å‚·å®³`;
                    else if(skill.type === 'heal') desc = `æ¢å¾© ${Math.round(skill.val*100)}% æ”»æ“ŠåŠ›ç”Ÿå‘½`;
                    else if(skill.type === 'lifesteal') desc = `å¸è¡€ ${Math.round(skill.val*100)}% å‚·å®³`;
                    
                    if(skill.status) desc += ` +${skill.status.name}`;

                    row.innerHTML = `
                        <div class="flex items-center gap-2"><span class="text-sm">${typeIcon}</span><span class="text-xs font-bold text-gray-200">${skill.name}</span></div>
                        <div class="text-[10px] text-gray-400">${desc}</div>
                    `;
                    skillList.appendChild(row);
                });
            }

            UI.hide('detail-upgrade-section');
            UI.hide('detail-equip-section');
            UI.show('detail-skills-section');
            UI.show('detail-passive-section');
            UI.show('detail-unowned-msg');
            
            UI.showFlex('char-detail-overlay');
        }

        function openCharDetail(index, fromGallery = false) {
            selectedCharIndex = index;
            const char = gameState.inventory[index];
            const baseChar = CHARACTERS_DB.find(c => c.id === char.baseId);

            UI.setText('detail-name', char.name);
            UI.setText('detail-rarity', char.rarity);
            
            const rarityEl = document.getElementById('detail-rarity');
            if(rarityEl) rarityEl.className = `text-sm font-bold mb-2 text-${char.rarity}`;
            
            UI.setText('detail-class', char.desc);
            UI.setSrc('detail-img', getCharImage(char));

            const elemContainer = document.getElementById('detail-elements');
            if(elemContainer) {
                 const elName = {fire:'ç«', water:'æ°´', wind:'é¢¨', earth:'åœ°', light:'å…‰', dark:'æš—'}[char.element];
                 const elColor = {fire:'bg-red-600', water:'bg-blue-600', wind:'bg-green-600', earth:'bg-yellow-600', light:'bg-yellow-300 text-black', dark:'bg-gray-700'}[char.element];
                 const typeName = {phys:'ç‰©ç†', mag:'é­”æ³•'}[char.type] || 'ç‰©ç†';
                 
                 elemContainer.innerHTML = `
                    <span class="${elColor} px-2 py-1 rounded border border-white/20 font-bold shadow-md">${elName}</span>
                    <span class="bg-gray-600 px-2 py-1 rounded border border-white/20 shadow-md">${typeName}</span>
                 `;
            }
            
            const passiveInfo = document.getElementById('detail-passive-info');
            if (passiveInfo && char.passive) {
                 passiveInfo.innerHTML = `
                    <div class="font-bold text-white mb-1">${char.passive.name}</div>
                    <div class="text-indigo-200 text-xs">${char.passive.desc}</div>
                `;
            }

            const skillList = document.getElementById('detail-skills-list');
            if(skillList) {
                skillList.innerHTML = '';
                char.skills.forEach((skill, idx) => {
                    const row = document.createElement('div');
                    row.className = 'flex flex-col bg-black/20 p-2 rounded hover:bg-black/40 transition';
                    let typeIcon = skill.type === 'heal' ? 'ğŸ’š' : (skill.type === 'aoe' ? 'ğŸ’¥' : 'âš”ï¸');
                    if (idx === 2) typeIcon = 'âš¡'; 

                    let desc = "";
                    if(skill.type === 'dmg') desc = `é€ æˆ ${Math.round(skill.val*100)}% æ”»æ“ŠåŠ›çš„å‚·å®³`;
                    else if(skill.type === 'aoe') desc = `å°å…¨é«”æ•µäººé€ æˆ ${Math.round(skill.val*100)}% å‚·å®³`;
                    else if(skill.type === 'heal') desc = `æ¢å¾©å‹æ–¹ ${Math.round(skill.val*100)}% æ”»æ“ŠåŠ›çš„ç”Ÿå‘½å€¼`;
                    else if(skill.type === 'lifesteal') desc = `é€ æˆ ${Math.round(skill.val*100)}% å‚·å®³ä¸¦å¸å–ç”Ÿå‘½`;
                    
                    if(skill.status) desc += `ï¼Œä¸¦é™„åŠ ${skill.status.name}`;

                    row.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <div class="flex items-center gap-2"><span class="text-sm">${typeIcon}</span><span class="text-xs font-bold text-gray-200">${skill.name}</span></div>
                            <span class="text-[10px] text-gray-500 bg-gray-800 px-1 rounded">CD:${skill.cd}</span>
                        </div>
                        <div class="text-[10px] text-gray-400 pl-6">${desc}</div>
                    `;
                    skillList.appendChild(row);
                });
            }

            UI.setText('detail-story', baseChar.story || "æš«ç„¡æ•…äº‹ã€‚");
            
            UI.show('detail-upgrade-section');
            UI.show('detail-skills-section');
            UI.show('detail-passive-section');
            UI.hide('detail-unowned-msg');
            
            if (fromGallery) {
                UI.hide('detail-buttons');
                UI.hide('detail-equip-section');
            } else {
                UI.show('detail-buttons');
                UI.show('detail-equip-section');
            }

            updateDetailStats();
            renderEquipSlots();
            UI.showFlex('char-detail-overlay');
        }
        
        function getCharStats(char) {
            const maxLvl = (char.limitBreak || 0) * 20 + 20;
            const growth = char.rarity==='SSR'?12 : (char.rarity==='SR'?8 : 5);
            const atkGrowth = char.rarity==='SSR'?3 : (char.rarity==='SR'?2 : 1);
            const baseChar = CHARACTERS_DB.find(c => c.id === char.baseId);
            
            let hp = baseChar.hp + (char.level - 1) * growth;
            let atk = baseChar.atk + (char.level - 1) * atkGrowth;
            let spd = baseChar.spd || 100; // Base SPD
            let cdRed = 0; 
            
            if(char.equipment) {
                ['weapon', 'armor', 'accessory'].forEach(slot => {
                     const equipId = char.equipment[slot];
                     if(equipId) {
                         const equip = gameState.equipment.find(e => e.instanceId === equipId);
                         if(equip) {
                             hp += (equip.hp || 0);
                             atk += (equip.atk || 0);
                             spd += (equip.spd || 0); // Equip SPD
                             cdRed += (equip.cdRed || 0); 
                         }
                     }
                });
            }
            
            return { hp, atk, spd, maxLvl, cdRed };
        }

        function updateDetailStats() {
            if (selectedCharIndex === -1) return;
            const char = gameState.inventory[selectedCharIndex];
            const stats = getCharStats(char);
            const baseChar = CHARACTERS_DB.find(c => c.id === char.baseId);
            
            const growth = char.rarity==='SSR'?12 : (char.rarity==='SR'?8 : 5);
            const atkGrowth = char.rarity==='SSR'?3 : (char.rarity==='SR'?2 : 1);
            const baseHp = baseChar.hp + (char.level - 1) * growth;
            const baseAtk = baseChar.atk + (char.level - 1) * atkGrowth;
            const baseSpd = baseChar.spd || 100;

            const bonusHp = stats.hp - baseHp;
            const bonusAtk = stats.atk - baseAtk;
            const bonusSpd = stats.spd - baseSpd;

            UI.setHtml('detail-hp', `${baseHp} ${bonusHp > 0 ? `<span class="text-green-400 text-xs">+${bonusHp}</span>` : ''}`);
            UI.setHtml('detail-atk', `${baseAtk} ${bonusAtk > 0 ? `<span class="text-green-400 text-xs">+${bonusAtk}</span>` : ''}`);
            UI.setHtml('detail-spd', `${baseSpd} ${bonusSpd !== 0 ? `<span class="${bonusSpd>0?'text-green-400':'text-red-400'} text-xs">${bonusSpd>0?'+':''}${bonusSpd}</span>` : ''}`);
            UI.setText('detail-lvl', char.level);
            UI.setText('detail-max-lvl', stats.maxLvl);
            UI.setText('detail-global-exp', gameState.globalExp || 0);
            UI.setText('detail-dupes', char.duplicates || 0);

            // ... level up button logic ...
            const btnLv = document.getElementById('btn-levelup');
            const expCost = char.level * 100; 
            const trueMax = 99;
            const currentCap = Math.min(trueMax, stats.maxLvl);

            if(btnLv) {
                if (char.level >= currentCap) {
                    btnLv.classList.add('hidden');
                } else {
                    btnLv.classList.remove('hidden');
                    btnLv.innerHTML = `å‡ç´š <br><span class="text-xs font-normal opacity-80">-${expCost} EXP</span>`;
                    btnLv.disabled = gameState.globalExp < expCost;
                    if(btnLv.disabled) btnLv.classList.add('opacity-50', 'cursor-not-allowed');
                    else btnLv.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }

            const btnEv = document.getElementById('btn-evolve');
            const msgMax = document.getElementById('max-level-msg');
            
            if (char.level >= currentCap && char.limitBreak < 4) {
                if(btnEv) btnEv.classList.remove('hidden');
                if(btnEv) btnEv.disabled = (char.duplicates || 0) <= 0;
                if(msgMax) msgMax.classList.add('hidden');
            } else if (char.level >= 99) {
                if(btnEv) btnEv.classList.add('hidden');
                if(msgMax) msgMax.classList.remove('hidden');
                if(msgMax) msgMax.innerText = "å·²é”æœ€é«˜ç­‰ç´š (MAX)";
            } else if (char.level >= currentCap && char.limitBreak >= 4) {
                 if(btnEv) btnEv.classList.add('hidden');
            } else {
                if(btnEv) btnEv.classList.add('hidden');
                if(msgMax) msgMax.classList.add('hidden');
            }
        }
        
        function renderEquipSlots() {
            const char = gameState.inventory[selectedCharIndex];
            ['weapon', 'armor', 'accessory'].forEach(slot => {
                const el = document.getElementById(`slot-${slot}`);
                if(!el) return;
                const equipId = char.equipment ? char.equipment[slot] : null;
                
                if (equipId) {
                    const equip = gameState.equipment.find(e => e.instanceId === equipId);
                    if (equip) {
                        el.className = `equip-slot equip-filled rare-${equip.rarity}`;
                        el.innerHTML = `<span class="equip-icon">${equip.icon}</span>`;
                        return;
                    }
                }
                el.className = `equip-slot`;
                el.innerHTML = `<i class="fas fa-plus text-gray-500"></i>`;
            });
        }
        
        function openEquipSelect(slotType) {
            currentEquipSlotType = slotType;
            const container = document.getElementById('equip-list-container');
            if(!container) return;
            container.innerHTML = '';
            
            const char = gameState.inventory[selectedCharIndex];
            const currentEquipId = char.equipment ? char.equipment[slotType] : null;
            
            const unequipDiv = document.createElement('div');
            unequipDiv.className = "p-3 bg-red-900/30 border border-red-800 rounded flex justify-center cursor-pointer hover:bg-red-800/50 mb-2";
            unequipDiv.innerHTML = `<span class="text-red-300">å¸ä¸‹è£å‚™</span>`;
            unequipDiv.onclick = () => performEquip(null);
            container.appendChild(unequipDiv);

            const available = gameState.equipment.filter(e => e.type === slotType && (!e.isEquipped || e.instanceId === currentEquipId));
            
            if(available.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.className = "text-center text-gray-500 py-4";
                emptyMsg.innerText = "ç„¡å¯ç”¨è£å‚™";
                container.appendChild(emptyMsg);
            }

            available.forEach(eq => {
                const div = document.createElement('div');
                const isCur = eq.instanceId === currentEquipId;
                div.className = `p-3 bg-gray-800 border ${isCur ? 'border-yellow-500 bg-yellow-900/20' : 'border-gray-600'} rounded flex justify-between items-center cursor-pointer hover:bg-gray-700`;
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="text-2xl">${eq.icon}</div>
                        <div>
                            <div class="font-bold text-${eq.rarity}">${eq.name}</div>
                            <div class="text-xs text-gray-400">
                                ${eq.atk > 0 ? `ATK+${eq.atk} ` : ''} 
                                ${eq.hp > 0 ? `HP+${eq.hp} ` : ''}
                                ${eq.spd !== 0 && eq.spd !== undefined ? `<span class="text-cyan-400 font-bold ml-1">SPD${eq.spd>0?'+':''}${eq.spd}</span>` : ''}
                                ${eq.cdRed > 0 ? `<span class="text-yellow-400 font-bold ml-1">CD-${eq.cdRed}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    ${isCur ? '<i class="fas fa-check text-yellow-500"></i>' : ''}
                `;
                div.onclick = () => performEquip(eq.instanceId);
                container.appendChild(div);
            });
            
            UI.show('equip-select-overlay');
        }
        
        function closeEquipSelect() { UI.hide('equip-select-overlay'); }
        
        function performEquip(equipId) {
            const char = gameState.inventory[selectedCharIndex];
            const currentId = char.equipment[currentEquipSlotType];
            if (currentId) {
                const oldEquip = gameState.equipment.find(e => e.instanceId === currentId);
                if (oldEquip) oldEquip.isEquipped = false;
            }
            char.equipment[currentEquipSlotType] = equipId;
            if (equipId) {
                const newEquip = gameState.equipment.find(e => e.instanceId === equipId);
                if (newEquip) {
                    if (newEquip.isEquipped) {
                        const owner = gameState.inventory.find(c => c.equipment && c.equipment[currentEquipSlotType] === equipId && c !== char);
                        if (owner) owner.equipment[currentEquipSlotType] = null;
                    }
                    newEquip.isEquipped = true;
                }
            }
            saveGame();
            closeEquipSelect();
            updateDetailStats();
            renderEquipSlots();
            SoundManager.play('click');
        }

        // ... (Level up, Evolve, Team Logic, Card Creation remain same) ...
        function performLevelUp() {
            const char = gameState.inventory[selectedCharIndex];
            const expCost = char.level * 100;
            if (gameState.globalExp >= expCost) {
                gameState.globalExp -= expCost;
                char.level++;
                SoundManager.play('levelup');
                saveGame();
                updateUI();
                updateDetailStats();
                renderCharsList(); 
            }
        }

        function performEvolve() {
            const char = gameState.inventory[selectedCharIndex];
            if ((char.duplicates || 0) > 0) {
                char.duplicates--;
                char.limitBreak = (char.limitBreak || 0) + 1;
                SoundManager.play('gacha'); 
                alert('çªç ´æˆåŠŸï¼ç­‰ç´šä¸Šé™æå‡ï¼');
                saveGame();
                updateDetailStats();
                renderCharsList();
            }
        }

        function closeCharDetail() { UI.hideFlex('char-detail-overlay'); }
        function renderTeamView() {
            const teamContainer = document.getElementById('current-team-container');
            const countDisplay = document.getElementById('team-count-display');
            if(!teamContainer) return;
            const currentSize = gameState.team.length;
            if(countDisplay) countDisplay.innerText = `${currentSize}/5 UNITS`;
            teamContainer.innerHTML = '';
            for(let i=0; i<5; i++) {
                const invIndex = gameState.team[i];
                if (invIndex !== undefined) {
                    const char = gameState.inventory[invIndex];
                    if (!char) { gameState.team.splice(i, 1); i--; continue; }
                    const slotDiv = document.createElement('div');
                    slotDiv.className = "relative group flex-shrink-0"; 
                    const removeBtn = document.createElement('div');
                    removeBtn.className = "absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs z-30 cursor-pointer shadow-md transform scale-0 group-hover:scale-100 transition-transform";
                    removeBtn.innerHTML = "<i class='fas fa-times'></i>";
                    removeBtn.onclick = (e) => { e.stopPropagation(); removeFromTeam(i); };
                    const card = createCharCard(char, true, () => {}); 
                    card.classList.remove('hover:scale-105'); 
                    slotDiv.appendChild(removeBtn);
                    slotDiv.appendChild(card);
                    teamContainer.appendChild(slotDiv);
                } else {
                    const emptySlot = document.createElement('div');
                    emptySlot.className = 'w-32 h-48 border-2 border-dashed border-gray-600 rounded-xl flex flex-col items-center justify-center text-gray-600 bg-gray-800/30 flex-shrink-0';
                    emptySlot.innerHTML = `<i class="fas fa-plus text-2xl mb-2 opacity-50"></i><span class="text-[10px] font-bold">EMPTY</span>`;
                    teamContainer.appendChild(emptySlot);
                }
            }
            renderInventory('all');
        }
        function filterInventory(filter) { SoundManager.play('click'); renderInventory(filter); }
        function renderInventory(filter) {
            const invContainer = document.getElementById('inventory-container');
            if(!invContainer) return;
            invContainer.innerHTML = '';
            const rarityWeight = { 'SSR': 3, 'SR': 2, 'R': 1 };
            let displayList = gameState.inventory.map((char, index) => ({ char, index }));
            if (filter !== 'all') displayList = displayList.filter(item => item.char.rarity === filter);
            displayList.sort((a, b) => {
                const weightA = rarityWeight[a.char.rarity] || 0;
                const weightB = rarityWeight[b.char.rarity] || 0;
                if (weightA !== weightB) return weightB - weightA;
                return (b.char.level || 1) - (a.char.level || 1);
            });
            displayList.forEach(item => {
                const char = item.char;
                const index = item.index;
                const isInTeam = gameState.team.includes(index);
                const div = createCharCard(char, false, () => addToTeam(index));
                if (isInTeam) {
                    const overlay = document.createElement('div');
                    overlay.className = "absolute inset-0 bg-black/60 flex items-center justify-center z-30 backdrop-blur-[1px]";
                    overlay.innerHTML = `<span class="text-xs font-bold text-white border border-white/50 px-2 py-1 rounded bg-black/50">å·²å‡ºæˆ°</span>`;
                    div.appendChild(overlay);
                    div.onclick = null;
                    div.classList.remove('hover:scale-105', 'cursor-pointer');
                    div.classList.add('cursor-default');
                }
                invContainer.appendChild(div);
            });
        }
        function createCharCard(char, isTeamCard, onClick) {
            const div = document.createElement('div');
            const imgUrl = getCharImage(char);
            let sizeClasses = "w-full h-64"; let avatarSize = "w-28 h-28"; let nameClasses = "text-xs"; let topMargin = "mt-2";
            if (isTeamCard) { sizeClasses = "w-32 h-48 flex-shrink-0"; avatarSize = "w-20 h-20"; nameClasses = "text-[11px]"; topMargin = "mt-4"; }
            div.className = `relative rounded-xl overflow-hidden card-${char.rarity} border-2 shadow-lg ${sizeClasses} ${!isTeamCard ? 'cursor-pointer hover:scale-105 transition duration-200' : ''}`;
            const eleMap = { fire: {icon:'ğŸ”¥', bg:'bg-red-900'}, water: {icon:'ğŸ’§', bg:'bg-blue-900'}, wind: {icon:'ğŸŒ¬ï¸', bg:'bg-green-900'}, earth: {icon:'â›°ï¸', bg:'bg-yellow-900'}, light: {icon:'âœ¨', bg:'bg-yellow-600'}, dark: {icon:'ğŸŒ‘', bg:'bg-gray-800'} };
            const eleData = eleMap[char.element] || {icon:'â“', bg:'bg-gray-700'};
            const typeMap = { phys: {icon:'âš”ï¸', label:'ç‰©ç†'}, mag: {icon:'ğŸ”®', label:'é­”æ³•'} };
            const typeData = typeMap[char.type] || {icon:'â“', label:'æœªçŸ¥'};
            div.innerHTML = `
                <div class="bg-black bg-opacity-40 w-full h-full flex flex-col items-center justify-center p-1 relative">
                    <div class="absolute top-1 left-1 text-[10px] text-green-400 font-bold bg-black bg-opacity-70 px-1 rounded z-10">Lv.${char.level || 1}</div>
                    <div class="text-xs font-bold text-${char.rarity} absolute top-1 right-1 z-10 bg-black bg-opacity-50 px-1 rounded shadow">${char.rarity}</div>
                    <div class="${avatarSize} rounded-full overflow-hidden border-2 border-white/20 mb-1 ${topMargin} bg-gray-800 shadow-inner relative flex-shrink-0">
                        <img src="${imgUrl}" class="w-full h-full object-cover">
                        <div class="absolute bottom-0 right-0 bg-black bg-opacity-70 text-white w-6 h-6 flex items-center justify-center rounded-tl text-[10px] z-20 shadow-sm border-l border-t border-white/20" title="${char.name}">${char.icon}</div>
                    </div>
                    <div class="${nameClasses} font-bold text-white text-center leading-tight truncate w-full z-10 relative px-1 drop-shadow-md mb-1">${char.name}</div>
                    <div class="flex items-center gap-1 mb-1 z-10">
                        <div class="flex items-center justify-center w-5 h-5 rounded-full ${eleData.bg} border border-white/30 text-[10px]" title="å±¬æ€§: ${char.element}">${eleData.icon}</div>
                        <div class="flex items-center justify-center w-5 h-5 rounded-full bg-gray-700 border border-white/30 text-[10px]" title="é¡å‹: ${typeData.label}">${typeData.icon}</div>
                    </div>
                    <div class="text-[10px] text-gray-300 mt-auto mb-2 z-10 font-mono bg-black/30 px-2 rounded">ATK ${char.atk}</div>
                    ${char.duplicates > 0 ? `<div class="absolute top-8 right-1 bg-purple-600 text-white text-[9px] px-1 rounded z-20">+${char.duplicates}</div>` : ''}
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-black/20 pointer-events-none"></div>
                </div>`;
            div.onclick = () => { if (onClick) { SoundManager.play('click'); onClick(); } };
            return div;
        }
        function addToTeam(invIndex) {
            if (gameState.team.length >= 5) { alert('éšŠä¼å·²æ»¿ï¼è«‹å…ˆç§»é™¤ä¸€åæˆå“¡ã€‚'); return; } 
            if (gameState.team.includes(invIndex)) return;
            gameState.team.push(invIndex);
            saveGame();
            renderTeamView();
        }
        function removeFromTeam(teamPos) {
            gameState.team.splice(teamPos, 1);
            saveGame();
            renderTeamView();
        }
        function switchCampaignTab(tab) {
            SoundManager.play('click');
            currentCampaignTab = tab;
            renderCampaigns();
            const btnStory = document.getElementById('tab-story');
            const btnRes = document.getElementById('tab-resource');
            if (tab === 'story') {
                btnStory.classList.add('bg-blue-600', 'text-white', 'border-blue-400');
                btnStory.classList.remove('bg-gray-700', 'text-gray-300', 'border-gray-600');
                btnRes.classList.add('bg-gray-700', 'text-gray-300', 'border-gray-600');
                btnRes.classList.remove('bg-blue-600', 'text-white', 'border-blue-400');
            } else {
                btnRes.classList.add('bg-blue-600', 'text-white', 'border-blue-400');
                btnRes.classList.remove('bg-gray-700', 'text-gray-300', 'border-gray-600');
                btnStory.classList.add('bg-gray-700', 'text-gray-300', 'border-gray-600');
                btnStory.classList.remove('bg-blue-600', 'text-white', 'border-blue-400');
            }
        }
        function renderCampaigns() {
            const list = document.getElementById('campaign-list');
            if(!list) return;
            list.innerHTML = '';
            const stages = currentCampaignTab === 'story' ? STORY_CHAPTERS : RESOURCE_STAGES;
            stages.forEach(stage => {
                const btn = document.createElement('button');
                btn.className = `w-full bg-gradient-to-r from-${stage.color}-800 to-${stage.color}-600 hover:from-${stage.color}-700 hover:to-${stage.color}-500 text-white font-bold py-4 px-6 rounded-xl shadow-lg transform hover:translate-x-2 transition flex justify-between items-center border-l-4 border-${stage.color}-400 group text-left relative overflow-hidden`;
                btn.onclick = () => startBattle(stage.id);
                let icon = 'skull';
                if (currentCampaignTab === 'story') {
                    if(stage.id.startsWith('s1')) icon='tree';
                    if(stage.id.startsWith('s2')) icon='dungeon';
                    if(stage.id.startsWith('s3')) icon='moon';
                    if(stage.id.startsWith('s4')) icon='ghost';
                    if(stage.id.startsWith('s5')) icon='hammer';
                    if(stage.id.startsWith('s6')) icon='mountain';
                    if(stage.id.startsWith('s7')) icon='dragon';
                    if(stage.id.startsWith('s8')) icon='eye';
                } else {
                    if (stage.id.includes('exp')) icon = 'book';
                    if (stage.id.includes('eq')) icon = 'treasure-chest';
                }
                const descHtml = stage.desc ? `<div class="text-[11px] text-${stage.color}-200 mt-1 font-normal opacity-80 truncate w-10/12">${stage.desc}</div>` : '';
                btn.innerHTML = `
                    <div class="flex-1 z-10">
                        <span class="text-xl group-hover:pl-2 transition-all flex items-center"><i class="fas fa-${icon} mr-3 w-6 text-center"></i> ${stage.name}</span>
                        ${descHtml}
                    </div>
                    <div class="flex flex-col items-end z-10 ml-4 shrink-0">
                        <span class="text-xs bg-black bg-opacity-40 px-3 py-1 rounded-full font-mono text-${stage.color}-200 mb-1">Lv.${stage.recLv}</span>
                        <div class="text-[10px] text-gray-300 font-mono flex flex-col items-end">
                            <span>Exp:${stage.exp}</span>
                            ${stage.dropRate ? '<span class="text-yellow-300">æ‰å¯¶UP</span>' : ''}
                        </div>
                    </div>
                    <div class="absolute right-0 bottom-0 text-8xl opacity-10 pointer-events-none transform translate-x-4 translate-y-4 text-white"><i class="fas fa-${icon}"></i></div>
                `;
                list.appendChild(btn);
            });
        }

        // --- Battle System Updates ---
        function startBattle(stageId) {
            if (gameState.team.length === 0) { alert('è«‹å…ˆé…ç½®éšŠä¼ï¼'); return; }
            
            const validTeam = gameState.team.every(idx => gameState.inventory[idx]);
            if (!validTeam) {
                alert('éšŠä¼è³‡æ–™ç•°å¸¸ï¼Œè«‹é‡æ–°ç·¨éšŠï¼');
                gameState.team = [];
                saveGame();
                switchView('team');
                return;
            }

            SoundManager.play('click');

            const stage = ALL_STAGES.find(s => s.id === stageId);
            if (!stage) { console.error("Stage not found:", stageId); return; }

            battleState.difficulty = stageId;
            battleState.turnCount = 1;
            battleState.active = true;
            battleState.gameOver = false;
            battleState.selectedSkillIndex = 0;
            battleState.isAuto = false; 
            
            // 1. Initialize Players
            battleState.players = gameState.team
                .map(invIndex => gameState.inventory[invIndex])
                .filter(char => char) 
                .map(char => {
                    const stats = getCharStats(char); 
                    const cooldowns = char.skills ? char.skills.map(() => 0) : [0, 0, 0];
                    return { 
                        ...char, 
                        baseHp: stats.hp,
                        baseAtk: stats.atk,
                        baseDef: (char.def || 10),
                        baseSpd: stats.spd, // Store Base
                        maxHp: stats.hp, 
                        currentHp: stats.hp, 
                        atk: stats.atk, 
                        def: (char.def || 10),
                        spd: stats.spd,     // Combat Stat
                        cdRed: stats.cdRed || 0,
                        cooldowns: cooldowns,
                        status: [],
                        critRate: 0.2, 
                        dodgeRate: 0.05,
                        eleBoost: {},
                        passive: char.passive,
                        isPlayer: true // Flag
                    };
                });
            
            // 2. Initialize Enemies
            battleState.enemies = [];
            stage.enemies.forEach((eKey, i) => {
                const template = ENEMIES_DATA[eKey];
                const scale = 1 + (stage.recLv * 0.05); 
                battleState.enemies.push({
                    ...template,
                    id: `enemy-${i}`,
                    baseHp: Math.floor(template.hp * scale),
                    baseAtk: Math.floor(template.atk * scale),
                    baseDef: (template.def || 5) + (stage.recLv * 0.2),
                    baseSpd: template.spd || 80, // Default enemy speed
                    currentHp: Math.floor(template.hp * scale),
                    maxHp: Math.floor(template.hp * scale),
                    atk: Math.floor(template.atk * scale),
                    def: (template.def || 5) + (stage.recLv * 0.2),
                    spd: template.spd || 80,
                    cooldowns: [0,0],
                    status: [],
                    critRate: 0.1,
                    dodgeRate: 0.05,
                    passive: template.passive,
                    isPlayer: false // Flag
                });
            });

            calculateAllStats();

            switchView('battle');
            updateBattleUI();
            
            // RESET BUTTON STATE
            const btn = document.getElementById('btn-auto-battle');
            const status = document.getElementById('auto-status');
            if(btn) btn.className = "absolute top-20 right-4 z-50 bg-gray-700/80 border border-gray-500 text-white px-4 py-2 rounded-full font-bold text-xs tracking-widest hover:bg-gray-600 transition-colors";
            if(status) {
                status.innerText = "OFF";
                status.className = "text-gray-400";
            }
            
            UI.show('skill-container');

            // START FIRST ROUND
            startNewRound();
        }

        // --- NEW: Round-Based Speed Logic ---
        function startNewRound() {
            if (!battleState.active) return;
            
            // Combine all alive units
            const allUnits = [...battleState.players, ...battleState.enemies].filter(u => u.currentHp > 0);
            
            if (allUnits.length === 0) { checkWinCondition(); return; }

            // Sort by Speed Descending
            allUnits.sort((a, b) => b.spd - a.spd);
            
            battleState.roundOrder = allUnits;
            battleState.roundIndex = 0;
            
            // Log Round Start
            toggleTurnIndicator(`ROUND ${battleState.turnCount}`);

            processNextTurn();
        }

        function processNextTurn() {
            if (!battleState.active || battleState.gameOver) return;

            // Check Round End
            if (battleState.roundIndex >= battleState.roundOrder.length) {
                battleState.turnCount++;
                // Cooldown reduction tick at end of round (or start, handled per action for players currently)
                // For simplicity, we reduce cooldowns when the character ACTS.
                startNewRound();
                return;
            }

            const currentUnit = battleState.roundOrder[battleState.roundIndex];

            // If unit died during the round, skip
            if (currentUnit.currentHp <= 0) {
                battleState.roundIndex++;
                processNextTurn();
                return;
            }

            // Identify Index for UI
            let unitIndex = -1;
            if (currentUnit.isPlayer) {
                unitIndex = battleState.players.indexOf(currentUnit);
                battleState.currentPlayerIndex = unitIndex; // Sync for UI buttons
            } else {
                unitIndex = battleState.enemies.indexOf(currentUnit);
            }

            // Process Status (Tick duration, Apply DoT)
            const canAct = processTurnStatus(currentUnit); 

            // Update UI to show who is active
            updateBattleUI(); 

            // If Stunned or Status prevented action
            if (!canAct || currentUnit.currentHp <= 0) {
                 battleState.roundIndex++;
                 setTimeout(processNextTurn, 500); // Small delay to see effect
                 return;
            }

            if (currentUnit.isPlayer) {
                // Player Turn
                battleState.turn = 0; // 0 = Player input allowed
                battleState.selectedSkillIndex = 0;
                
                // Reduce Cooldowns at start of their action
                currentUnit.cooldowns = currentUnit.cooldowns.map(cd => Math.max(0, cd - 1));
                
                updateActionButtons();
                
                if (battleState.isAuto) {
                    processAutoTurn();
                }
                // Else wait for player input (executeAttack)
            } else {
                // Enemy Turn
                battleState.turn = 1; // 1 = Input blocked
                updateActionButtons(); // Disable buttons visual
                setTimeout(performEnemyAction, 800);
            }
        }

        function calculateAllStats() {
            let playerTeamAtk = 0, playerTeamDef = 0, playerTeamHp = 0, playerTeamSpd = 0;
            let enemyDebuffAtkOnP = 0, enemyDebuffDefOnP = 0, enemyDebuffHpOnP = 0, enemyDebuffSpdOnP = 0;
            let enemyTeamAtk = 0, enemyTeamDef = 0, enemyTeamHp = 0, enemyTeamSpd = 0;
            let playerDebuffAtkOnE = 0, playerDebuffDefOnE = 0, playerDebuffHpOnE = 0, playerDebuffSpdOnE = 0;

            // Iterate Players
            battleState.players.forEach(p => {
                if (p.passive) {
                    if (p.passive.type === 'team_atk') playerTeamAtk += p.passive.val;
                    if (p.passive.type === 'team_def') playerTeamDef += p.passive.val;
                    if (p.passive.type === 'team_hp') playerTeamHp += p.passive.val;
                    if (p.passive.type === 'team_spd') playerTeamSpd += p.passive.val;
                    
                    if (p.passive.type === 'enemy_debuff_atk') playerDebuffAtkOnE += p.passive.val;
                    if (p.passive.type === 'enemy_debuff_def') playerDebuffDefOnE += p.passive.val;
                }
            });

            // Iterate Enemies
            battleState.enemies.forEach(e => {
                if (e.passive) {
                    if (e.passive.type === 'team_atk') enemyTeamAtk += e.passive.val;
                    if (e.passive.type === 'team_def') enemyTeamDef += e.passive.val;
                    if (e.passive.type === 'team_spd') enemyTeamSpd += e.passive.val;
                    
                    if (e.passive.type === 'enemy_debuff_atk') enemyDebuffAtkOnP += e.passive.val;
                    if (e.passive.type === 'enemy_debuff_def') enemyDebuffDefOnP += e.passive.val;
                    if (e.passive.type === 'enemy_debuff_hp') enemyDebuffHpOnP += e.passive.val;
                    if (e.passive.type === 'enemy_debuff_all') {
                        enemyDebuffAtkOnP += e.passive.val;
                        enemyDebuffDefOnP += e.passive.val;
                        enemyDebuffHpOnP += e.passive.val;
                    }
                }
            });

            // Apply to Players
            battleState.players.forEach(p => {
                let selfAtk = playerTeamAtk, selfDef = playerTeamDef, selfHp = playerTeamHp, selfSpd = playerTeamSpd;
                if (p.passive) {
                    if (p.passive.type === 'self_atk') selfAtk += p.passive.val;
                    if (p.passive.type === 'self_def') selfDef += p.passive.val;
                    if (p.passive.type === 'self_hp') selfHp += p.passive.val;
                    if (p.passive.type === 'self_spd') selfSpd += p.passive.val;
                    if (p.passive.type === 'crit_rate') p.critRate += p.passive.val;
                    if (p.passive.type === 'dodge') p.dodgeRate += p.passive.val;
                    if (p.passive.type === 'ele_fire_up') p.eleBoost = { ...p.eleBoost, fire: (p.eleBoost?.fire || 0) + p.passive.val };
                    if (p.passive.type === 'start_buff') {
                         p.status.push({ type: p.passive.buff, val: p.passive.val, dur: p.passive.dur, name: p.passive.name });
                    }
                }

                const atkMul = Math.max(0.1, (1 + selfAtk) * (1 - enemyDebuffAtkOnP));
                const defMul = Math.max(0.1, (1 + selfDef) * (1 - enemyDebuffDefOnP));
                const hpMul  = Math.max(0.1, (1 + selfHp) * (1 - enemyDebuffHpOnP));
                const spdMul = Math.max(0.1, (1 + selfSpd) * (1 - enemyDebuffSpdOnP));

                p.atk = Math.floor(p.baseAtk * atkMul);
                p.def = Math.floor(p.baseDef * defMul);
                p.maxHp = Math.floor(p.baseHp * hpMul);
                p.spd = Math.floor(p.baseSpd * spdMul);
                p.currentHp = p.maxHp;
            });

            // Apply to Enemies
            battleState.enemies.forEach(e => {
                let selfAtk = enemyTeamAtk, selfDef = enemyTeamDef, selfHp = enemyTeamHp, selfSpd = enemyTeamSpd;
                if (e.passive) {
                    if (e.passive.type === 'self_atk') selfAtk += e.passive.val;
                    if (e.passive.type === 'self_def') selfDef += e.passive.val;
                    if (e.passive.type === 'self_hp') selfHp += e.passive.val;
                    if (e.passive.type === 'crit_rate') e.critRate += e.passive.val;
                    if (e.passive.type === 'dodge') e.dodgeRate += e.passive.val;
                }

                const atkMul = Math.max(0.1, (1 + selfAtk) * (1 - playerDebuffAtkOnE));
                const defMul = Math.max(0.1, (1 + selfDef) * (1 - playerDebuffDefOnE));
                const hpMul  = Math.max(0.1, (1 + selfHp) * (1 - playerDebuffHpOnE));
                const spdMul = Math.max(0.1, (1 + selfSpd) * (1 - playerDebuffSpdOnE));

                e.atk = Math.floor(e.baseAtk * atkMul);
                e.def = Math.floor(e.baseDef * defMul);
                e.maxHp = Math.floor(e.baseHp * hpMul);
                e.spd = Math.floor(e.baseSpd * spdMul);
                e.currentHp = e.maxHp;
            });
        }

        // ... (Auto Battle Toggle) ...
        function toggleAutoBattle() {
            battleState.isAuto = !battleState.isAuto;
            // Visual Update
            const btn = document.getElementById('btn-auto-battle');
            const status = document.getElementById('auto-status');
            if(battleState.isAuto) {
                if(btn) btn.className = "absolute top-20 right-4 z-50 bg-yellow-600 border border-yellow-400 text-white px-4 py-2 rounded-full font-bold text-xs tracking-widest hover:bg-yellow-500 transition-colors shadow-[0_0_15px_rgba(234,179,8,0.5)]";
                if(status) { status.innerText = "ON"; status.className = "text-white"; }
                // If currently player turn, trigger auto
                if(battleState.turn === 0 && !battleState.gameOver) processAutoTurn();
            } else {
                if(btn) btn.className = "absolute top-20 right-4 z-50 bg-gray-700/80 border border-gray-500 text-white px-4 py-2 rounded-full font-bold text-xs tracking-widest hover:bg-gray-600 transition-colors";
                if(status) { status.innerText = "OFF"; status.className = "text-gray-400"; }
            }
        }

        // Updated for Action Queue
        function executeAttack(targetIndex) {
            // Can only act if it's Player's Turn (0)
            if (battleState.turn !== 0) return;
            
            const actingPlayer = battleState.players[battleState.currentPlayerIndex];
            if (!actingPlayer) return;
            
            const selectedSkill = actingPlayer.skills[battleState.selectedSkillIndex];
            const isHeal = selectedSkill.type === 'heal';

            const target = battleState.enemies[targetIndex]; 
            
            if (!isHeal) {
                if (!target) return; 
                if (target.currentHp <= 0) return; 
            }

            // FIX: Set Cooldown after usage
            if (selectedSkill.cd > 0) {
                let finalCD = selectedSkill.cd;
                // Apply CD Reduction from equipment/stats if applicable
                if (actingPlayer.cdRed > 0) {
                    finalCD = Math.max(0, finalCD - actingPlayer.cdRed);
                }
                actingPlayer.cooldowns[battleState.selectedSkillIndex] = finalCD;
            }

            const attacker = actingPlayer;
            const skill = selectedSkill;
            
            // Execute Action
            if (battleState.selectedSkillIndex === 2) {
                playUltimateCutin(attacker, skill, () => { 
                    performAttackLogic(attacker, skill, targetIndex, battleState.currentPlayerIndex); 
                    finishAction();
                });
            } else { 
                performAttackLogic(attacker, skill, targetIndex, battleState.currentPlayerIndex); 
                finishAction();
            }
        }

        function finishAction() {
            const enemiesAlive = battleState.enemies.some(e => e.currentHp > 0);
            if (!enemiesAlive) { checkWinCondition(); return; }

            // Move to next unit in round
            battleState.roundIndex++;
            processNextTurn();
        }

        // Updated for Action Queue (Single Enemy Action)
        function performEnemyAction() {
            if (!battleState.active || battleState.gameOver) return;

            const currentUnit = battleState.roundOrder[battleState.roundIndex];
            // Safety check: is it actually an enemy?
            if (!currentUnit || currentUnit.isPlayer) {
                // Should not happen, but recover
                finishAction();
                return;
            }

            const enemy = currentUnit;
            const enemyIndex = battleState.enemies.indexOf(enemy);
            const enemyEl = document.getElementById(`enemy-el-${enemyIndex}`);
            
            const alivePlayers = battleState.players.filter(p => p.currentHp > 0);
            if (alivePlayers.length === 0) { checkWinCondition(); return; }

            let usedSkill = false;
            
            if (enemy.skills && enemy.skills.length > 0) {
                const roll = Math.random();
                let cumulativeProb = 0;
                for (const skill of enemy.skills) {
                    cumulativeProb += (skill.prob || 0.3);
                    if (roll < cumulativeProb) {
                        usedSkill = true;
                        showSkillText(enemyEl, skill.name);
                        
                        const applyEnemySkillStatus = (target) => {
                            if (skill.status) {
                                    if (skill.status.chance && Math.random() > skill.status.chance) return;
                                    applyStatus(target, skill.status);
                            }
                        };

                        if (skill.type === 'aoe') {
                            alivePlayers.forEach(p => {
                                const pIdx = battleState.players.indexOf(p);
                                const targetEl = document.getElementById(`player-el-${pIdx}`);
                                if (targetEl) createBattleEffect(targetEl, 'magic');
                                
                                const result = calculateDamage(enemy, p, skill.val);

                                if(!result.isDodge) {
                                    p.currentHp -= result.damage;
                                    showDamageText(targetEl, result);
                                    applyEnemySkillStatus(p);
                                } else {
                                    showDamageText(targetEl, result);
                                }
                            });
                            SoundManager.play('heavy_attack');
                        } else if (skill.type === 'heal') {
                            if(enemyEl) createBattleEffect(enemyEl, 'heal');
                            const healAmount = Math.floor(enemy.maxHp * skill.val);
                            enemy.currentHp = Math.min(enemy.maxHp, enemy.currentHp + healAmount);
                            showHealText(enemyEl, healAmount);
                            SoundManager.play('heal');
                        } else if (skill.type === 'lifesteal') {
                            const tauntTargets = alivePlayers.filter(p => p.status.some(s => s.type === 'taunt'));
                            const target = tauntTargets.length > 0 ? tauntTargets[0] : alivePlayers[Math.floor(Math.random() * alivePlayers.length)];
                            const targetIndex = battleState.players.indexOf(target);
                            const targetEl = document.getElementById(`player-el-${targetIndex}`);
                            
                            if(targetEl) createBattleEffect(targetEl, 'slash');
                            const result = calculateDamage(enemy, target, skill.val);

                            if(!result.isDodge) {
                                target.currentHp -= result.damage;
                                enemy.currentHp = Math.min(enemy.maxHp, enemy.currentHp + Math.floor(result.damage * 0.5));
                                showDamageText(targetEl, result);
                                showHealText(enemyEl, Math.floor(result.damage * 0.5));
                                SoundManager.play('attack');
                            } else {
                                showDamageText(targetEl, result);
                            }
                        } else {
                            const tauntTargets = alivePlayers.filter(p => p.status.some(s => s.type === 'taunt'));
                            const target = tauntTargets.length > 0 ? tauntTargets[0] : alivePlayers[Math.floor(Math.random() * alivePlayers.length)];
                            const targetIndex = battleState.players.indexOf(target);
                            const targetEl = document.getElementById(`player-el-${targetIndex}`);
                            
                            if(targetEl) createBattleEffect(targetEl, 'slash');
                            const result = calculateDamage(enemy, target, skill.val);

                            if(!result.isDodge) {
                                target.currentHp -= result.damage;
                                showDamageText(targetEl, result);
                                applyEnemySkillStatus(target);
                            } else {
                                showDamageText(targetEl, result);
                            }
                            SoundManager.play('heavy_attack');
                        }
                        break;
                    }
                }
            }

            if (!usedSkill) {
                const tauntTargets = alivePlayers.filter(p => p.status.some(s => s.type === 'taunt'));
                const target = tauntTargets.length > 0 ? tauntTargets[0] : alivePlayers[Math.floor(Math.random() * alivePlayers.length)];
                const targetIndex = battleState.players.indexOf(target);
                const targetEl = document.getElementById(`player-el-${targetIndex}`);
                
                if (enemyEl) { enemyEl.classList.add('shake'); setTimeout(() => enemyEl.classList.remove('shake'), 500); }
                if(targetEl) createBattleEffect(targetEl, 'slash');
                SoundManager.play('damage');

                const result = calculateDamage(enemy, target, 1.0);
                if (!result.isDodge) target.currentHp -= result.damage;
                showDamageText(targetEl, result);
            }

            updateBattleUI(); 
            checkWinCondition();
            
            // Continue sequence
            finishAction();
        }

        // ... (endBattle, Status Logic remain similar) ...

        function checkWinCondition() {
            if (battleState.gameOver) return;
            const enemiesAlive = battleState.enemies.some(e => e.currentHp > 0);
            const playersAlive = battleState.players.some(p => p.currentHp > 0);
            if (!enemiesAlive) { battleState.gameOver = true; battleState.active = false; endBattle(true); } else if (!playersAlive) { battleState.gameOver = true; battleState.active = false; endBattle(false); }
        }

        // Updated UpdateBattleUI to highlight ACTIVE UNIT in the Round Queue
        function updateBattleUI() {
            const pContainer = document.getElementById('player-container');
            const eContainer = document.getElementById('enemy-container');
            if(eContainer) eContainer.innerHTML = '';
            
            const currentActor = battleState.roundOrder[battleState.roundIndex];
            
            // Allow clicking if it's Player Turn and not Auto
            const canInteract = (battleState.turn === 0) && !battleState.isAuto;

            if(eContainer) {
                battleState.enemies.forEach((e, i) => {
                    if (e.currentHp <= 0) return;
                    const div = document.createElement('div');
                    
                    const isActive = (currentActor === e);
                    
                    div.className = `battle-unit cursor-pointer ${isActive ? 'active-turn' : ''}`;
                    div.id = `enemy-el-${i}`;
                    div.onclick = () => executeAttack(i);
                    const hpPercent = (e.currentHp / e.maxHp) * 100;
                    const imgUrl = getCharImage(e, true);
                    
                    let statusHtml = '';
                    e.status.forEach(s => { /* ... icons ... */ 
                        let icon = '';
                        if(s.type === 'poison') icon = 'â˜ ï¸'; else if(s.type === 'burn') icon = 'ğŸ”¥'; else if(s.type === 'stun') icon = 'ğŸ’«'; else if(s.type === 'def_up') icon = 'ğŸ›¡ï¸'; else if(s.type === 'atk_up') icon = 'âš”ï¸'; else if(s.type === 'regen') icon = 'ğŸ’–';
                        let styleClass = '';
                        if(['def_up', 'atk_up', 'regen'].includes(s.type)) styleClass = 'status-buff'; else if(s.type === 'stun') styleClass = 'status-ctrl'; else styleClass = 'status-debuff';
                        statusHtml += `<div class="status-icon ${styleClass}">${icon}</div>`;
                    });

                    // Add passive icon
                    let passiveIndicator = e.passive ? `<div class="absolute top-0 left-0 text-[8px] bg-red-900 text-white px-1 rounded z-30">P</div>` : '';
                    
                    // Add Action Indicator if active
                    let activeInd = isActive ? `<div class="active-indicator"><i class="fas fa-caret-down"></i></div>` : '';

                    div.innerHTML = `
                        ${activeInd}
                        <div class="battle-status-container">${statusHtml}</div>
                        <div class="battle-hp-container"><div class="h-full bg-red-500 hp-bar-transition" style="width: ${hpPercent}%"></div></div>
                        <div class="battle-card-wrapper">
                            <div class="battle-avatar enemy-avatar ${e.isBoss ? 'enemy-boss' : ''}">
                                <img src="${imgUrl}"><div class="gloss-layer"></div>
                                ${e.isBoss ? '<div class="absolute top-0 right-0 text-yellow-400 text-xs p-1 z-20">âš ï¸</div>' : ''}
                                ${passiveIndicator}
                                <div class="element-badge ${e.element==='fire'?'ele-fire':e.element==='water'?'ele-water':e.element==='wind'?'ele-wind':e.element==='earth'?'ele-earth':e.element==='light'?'ele-light':'ele-dark'}">${e.element==='fire'?'ç«':e.element==='water'?'æ°´':e.element==='wind'?'é¢¨':e.element==='earth'?'åœ°':e.element==='light'?'å…‰':'æš—'}</div>
                            </div>
                        </div>
                        <div class="battle-base"></div>
                    `;
                    
                    if (!canInteract) { 
                        div.onclick = null; 
                        div.classList.remove('cursor-pointer'); 
                        if (battleState.isAuto && battleState.turn === 0) { div.style.cursor = 'not-allowed'; }
                    } 
                    eContainer.appendChild(div);
                });
            }

            if(pContainer) {
                pContainer.innerHTML = '';
                battleState.players.forEach((p, i) => {
                    const div = document.createElement('div');
                    
                    const isActive = (currentActor === p);
                    
                    div.className = `battle-unit ${isActive ? 'active-turn' : ''} ${p.currentHp <= 0 ? 'opacity-50 grayscale' : ''}`;
                    div.id = `player-el-${i}`;
                    const hpPercent = (p.currentHp / p.maxHp) * 100;
                    const imgUrl = getCharImage(p);

                    let statusHtml = '';
                    p.status.forEach(s => { 
                         let icon = ''; if(s.type === 'poison') icon = 'â˜ ï¸'; else if(s.type === 'burn') icon = 'ğŸ”¥'; else if(s.type === 'stun') icon = 'ğŸ’«'; else if(s.type === 'def_up') icon = 'ğŸ›¡ï¸'; else if(s.type === 'atk_up') icon = 'âš”ï¸'; else if(s.type === 'regen') icon = 'ğŸ’–';
                         let styleClass = ''; if(['def_up', 'atk_up', 'regen'].includes(s.type)) styleClass = 'status-buff'; else if(s.type === 'stun') styleClass = 'status-ctrl'; else styleClass = 'status-debuff';
                         statusHtml += `<div class="status-icon ${styleClass}">${icon}</div>`;
                    });

                    let activeInd = isActive ? `<div class="active-indicator"><i class="fas fa-caret-down"></i></div>` : '';

                    div.innerHTML = `
                        ${activeInd}
                        <div class="battle-status-container">${statusHtml}</div>
                        <div class="battle-hp-container"><div class="h-full bg-green-500 hp-bar-transition" style="width: ${hpPercent}%"></div></div>
                        <div class="battle-card-wrapper">
                            <div class="battle-avatar avatar-${p.rarity}">
                                <img src="${imgUrl}"><div class="gloss-layer"></div>
                                <div class="element-badge ${p.element==='fire'?'ele-fire':p.element==='water'?'ele-water':p.element==='wind'?'ele-wind':p.element==='earth'?'ele-earth':p.element==='light'?'ele-light':'ele-dark'}">${p.element==='fire'?'ç«':p.element==='water'?'æ°´':p.element==='wind'?'é¢¨':p.element==='earth'?'åœ°':p.element==='light'?'å…‰':'æš—'}</div>
                            </div>
                        </div>
                        <div class="battle-base"></div>
                    `;
                    pContainer.appendChild(div);
                });
            }
        }

        // ... rest of damage/effect logic ...
        function processAutoTurn() {
            if (!battleState.isAuto || battleState.turn !== 0 || battleState.gameOver) return;
            
            setTimeout(() => {
                if (!battleState.isAuto || battleState.turn !== 0 || battleState.gameOver) return;
                
                const player = battleState.players[battleState.currentPlayerIndex];
                if (!player || player.currentHp <= 0) return;

                const allies = battleState.players.filter(p => p.currentHp > 0);
                const needsHeal = allies.some(p => (p.currentHp / p.maxHp) < 0.7);

                let skillIdx = 0;
                const ultSkill = player.skills[2];
                const skill2 = player.skills[1];

                let useUlt = false;
                if (player.cooldowns[2] === 0) {
                    if (ultSkill.type === 'heal') { if (needsHeal) useUlt = true; } else { useUlt = true; }
                }

                let useS2 = false;
                if (!useUlt && player.cooldowns[1] === 0) {
                    if (skill2.type === 'heal') { if (needsHeal) useS2 = true; } else { useS2 = true; }
                }

                if (useUlt) skillIdx = 2; else if (useS2) skillIdx = 1; else skillIdx = 0; 

                battleState.selectedSkillIndex = skillIdx;
                updateActionButtons(); 

                const skill = player.skills[skillIdx];
                let targetIdx = 0; 

                if (skill.type === 'heal') {
                    targetIdx = 0; 
                } else {
                    const aliveEnemies = battleState.enemies.map((e, i) => ({ ...e, index: i })).filter(e => e.currentHp > 0);
                    if (aliveEnemies.length > 0) {
                        if (skillIdx === 2 && aliveEnemies.length > 1) {
                            aliveEnemies.sort((a, b) => b.currentHp - a.currentHp); 
                            targetIdx = aliveEnemies[0].index;
                        } else {
                            aliveEnemies.sort((a, b) => a.currentHp - b.currentHp); 
                            targetIdx = aliveEnemies[0].index;
                        }
                    }
                }
                executeAttack(targetIdx); 
            }, 600); 
        }

        function endBattle(win) {
            battleState.active = false;
            battleState.gameOver = true;
            UI.hide('skill-container');
            
            const title = document.getElementById('battle-result-title');
            const rewardEl = document.getElementById('battle-result-reward');
            
            UI.showFlex('battle-result-overlay');

            if (win) {
                SoundManager.play('win');
                if(title) {
                    title.innerText = "æˆ°é¬¥å‹åˆ©";
                    title.className = "text-6xl font-black text-yellow-400 mb-4 tracking-widest drop-shadow-[0_0_10px_rgba(250,204,21,0.8)] animate-bounce";
                }
                
                const stage = ALL_STAGES.find(s => s.id === battleState.difficulty);
                const gemReward = stage.gems;
                const expReward = stage.exp;
                
                let droppedEquip = null;
                const baseDropChance = stage.dropRate || 0.4;
                
                if (Math.random() < baseDropChance) { 
                    const equipPool = EQUIPMENT_DB.filter(e => e.rarity === 'R'); 
                    if (stage.recLv >= 20) equipPool.push(...EQUIPMENT_DB.filter(e => e.rarity === 'SR'));
                    if (stage.recLv >= 40) equipPool.push(...EQUIPMENT_DB.filter(e => e.rarity === 'SSR')); 
                    
                    const drop = equipPool[Math.floor(Math.random() * equipPool.length)];
                    droppedEquip = addEquipment(drop.id);
                }

                addGems(gemReward);
                addExp(expReward);
                
                let equipHtml = '';
                if(droppedEquip) {
                    equipHtml = `<div class="mt-4 text-sm text-yellow-300">ç²å¾—è£å‚™: ${droppedEquip.name}</div>`;
                }

                if(rewardEl) {
                    rewardEl.innerHTML = `
                        <div class="flex items-center gap-2"><i class="fas fa-gem text-purple-400"></i> ${gemReward} å¯¶çŸ³</div>
                        <div class="flex items-center gap-2 mt-2"><i class="fas fa-book text-blue-400"></i> ${expReward} ç¶“é©—å€¼</div>
                        ${equipHtml}
                    `;
                    rewardEl.classList.remove('hidden');
                }
            } else {
                SoundManager.play('lose');
                if(title) {
                    title.innerText = "æˆ°é¬¥å¤±æ•—";
                    title.className = "text-6xl font-black text-gray-500 mb-8 tracking-widest drop-shadow-[0_0_10px_rgba(0,0,0,0.8)]";
                }
                if(rewardEl) rewardEl.classList.add('hidden');
            }
        }

        function closeBattleResult() {
            SoundManager.play('click');
            UI.hideFlex('battle-result-overlay');
            switchView('adventure'); 
        }

        function applyStatus(target, status) {
            if (!target || target.currentHp <= 0) return;
            const existing = target.status.find(s => s.type === status.type);
            if (existing) {
                existing.dur = status.dur; 
            } else {
                target.status.push({ ...status });
            }
            const targetIndex = battleState.players.includes(target) 
                ? battleState.players.indexOf(target) 
                : battleState.enemies.indexOf(target);
            const isPlayer = battleState.players.includes(target);
            const elId = isPlayer ? `player-el-${targetIndex}` : `enemy-el-${targetIndex}`;
            showSkillText(document.getElementById(elId), status.name);
        }

        function processTurnStatus(unit) {
            if (!unit || unit.currentHp <= 0) return false; 
            
            let canAct = true;
            for (let i = unit.status.length - 1; i >= 0; i--) {
                const s = unit.status[i];
                const unitIndex = battleState.players.includes(unit) ? battleState.players.indexOf(unit) : battleState.enemies.indexOf(unit);
                const isPlayer = battleState.players.includes(unit);
                const el = document.getElementById(isPlayer ? `player-el-${unitIndex}` : `enemy-el-${unitIndex}`);

                if (s.type === 'poison') {
                    const dmg = Math.floor(unit.atk * s.val);
                    unit.currentHp -= dmg;
                    showDamageText(el, dmg, false);
                    createBattleEffect(el, 'magic'); 
                } else if (s.type === 'burn') {
                    const dmg = Math.floor(unit.atk * s.val);
                    unit.currentHp -= dmg;
                    showDamageText(el, dmg, false);
                    createBattleEffect(el, 'magic');
                } else if (s.type === 'regen') {
                    const heal = Math.floor(unit.maxHp * s.val);
                    unit.currentHp = Math.min(unit.maxHp, unit.currentHp + heal);
                    showHealText(el, heal);
                } else if (s.type === 'stun') {
                    canAct = false;
                    showSkillText(el, 'æšˆçœ©');
                }

                s.dur--;
                if (s.dur <= 0) {
                    unit.status.splice(i, 1);
                }
            }
            return canAct;
        }

        function updateActionButtons() {
            const container = document.getElementById('skill-container'); 
            if(!container) return;
            container.innerHTML = '';
            
            const currentPlayer = battleState.players[battleState.currentPlayerIndex];
            if(!currentPlayer || currentPlayer.currentHp <= 0) return;
            
            // IF ENEMY TURN, SHOW PLACEHOLDER OR DISABLE
            if(battleState.turn !== 0) {
                container.innerHTML = `<div class="col-span-3 text-center text-gray-500 py-4 font-bold border-2 border-gray-700 rounded bg-gray-800">æ•µæ–¹è¡Œå‹•ä¸­...</div>`;
                return;
            }

            const isAuto = battleState.isAuto;

            currentPlayer.skills.forEach((skill, index) => {
                const btn = document.createElement('button');
                const isSelected = battleState.selectedSkillIndex === index;
                const currentCD = currentPlayer.cooldowns[index];
                const isOnCD = currentCD > 0;
                const isUltimate = index === 2;
                let btnClass = "relative flex flex-col items-start justify-center p-2 rounded shadow transition text-left h-16 border-b-4 active:border-b-0 active:mt-1 ";
                
                if (isOnCD) btnClass += "bg-gray-600 border-gray-700 text-gray-400 cursor-not-allowed";
                else if (isSelected) btnClass += "bg-blue-600 hover:bg-blue-500 border-blue-800 text-white ring-2 ring-yellow-400";
                else btnClass += "bg-gray-700 hover:bg-gray-600 border-gray-800 text-gray-200";
                
                if (isUltimate && !isOnCD && !isSelected) btnClass += " border-purple-500 ring-1 ring-purple-400";
                
                if (isAuto) btnClass += " opacity-80 pointer-events-none"; 

                btn.className = btnClass;
                btn.onclick = () => { if (!isOnCD && !isAuto) { SoundManager.play('click'); selectSkill(index); } };
                
                let cdText = isOnCD ? `<span class="absolute top-1 right-1 text-xs text-red-400 font-bold">${currentCD}T</span>` : '';
                let typeIcon = skill.type === 'heal' ? 'ğŸ’š' : (skill.type === 'aoe' ? 'ğŸ’¥' : 'âš”ï¸');
                if (isUltimate) typeIcon = 'âš¡';
                btn.innerHTML = `<div class="text-sm font-bold w-full truncate">${typeIcon} ${skill.name}</div><div class="text-[10px] opacity-80 w-full truncate">${skill.desc || ''}</div>${cdText}`;
                container.appendChild(btn);
            });
        }
        
        function selectSkill(index) { battleState.selectedSkillIndex = index; updateActionButtons(); }
        
        function calculateDamage(attacker, target, skillVal) {
            const atkMod = 1 + (attacker.status.some(s => s.type === 'atk_up') ? 0.3 : 0);
            const defMod = 1 + (target.status.some(s => s.type === 'def_up') ? 0.3 : 0);
            let rawDmg = attacker.atk * atkMod;
            let reduction = (target.def || 0) * defMod;
            let damage = Math.max(1, Math.floor((rawDmg - reduction) * skillVal));
            let eleMod = 1.0;
            const adv = { 'fire':'wind', 'wind':'earth', 'earth':'water', 'water':'fire', 'light':'dark', 'dark':'light' };
            if (adv[attacker.element] === target.element) eleMod = 1.5;
            else if (adv[target.element] === attacker.element) eleMod = 0.5;
            if (attacker.eleBoost && attacker.eleBoost[attacker.element]) {
                damage = Math.floor(damage * (1 + attacker.eleBoost[attacker.element]));
            }
            damage = Math.floor(damage * eleMod);
            const critChance = attacker.critRate !== undefined ? attacker.critRate : 0.2;
            const isCrit = Math.random() < critChance; 
            if (isCrit) damage = Math.floor(damage * 1.5);
            const dodgeChance = target.dodgeRate !== undefined ? target.dodgeRate : 0.05;
            const isDodge = Math.random() < dodgeChance; 
            if (isDodge) { damage = 0; }
            return { damage, isCrit, isDodge, eleMod };
        }

        function performAttackLogic(attacker, skill, targetIndex, actorIndex) {
            const attackerEl = document.getElementById(attacker.isPlayer ? `player-el-${actorIndex}` : `enemy-el-${actorIndex}`);
            if (attackerEl) { attackerEl.classList.add('shake'); setTimeout(() => attackerEl.classList.remove('shake'), 500); }
            const applySkillStatus = (target) => {
                if (skill.status) {
                    if (skill.status.chance && Math.random() > skill.status.chance) return;
                    applyStatus(target, skill.status);
                }
            };
            const atkMod = 1 + (attacker.status.some(s => s.type === 'atk_up') ? 0.3 : 0); 

            if (skill.type === 'heal') {
                // Heals friends
                const friendList = attacker.isPlayer ? battleState.players : battleState.enemies;
                const targets = friendList.filter(p => p.currentHp > 0);
                const ally = targets.reduce((prev, curr) => (prev.currentHp / prev.maxHp < curr.currentHp / curr.maxHp) ? prev : curr);
                
                const allyIdx = friendList.indexOf(ally);
                const allyElId = attacker.isPlayer ? `player-el-${allyIdx}` : `enemy-el-${allyIdx}`;
                const allyEl = document.getElementById(allyElId);

                if(allyEl) createBattleEffect(allyEl, 'heal');
                SoundManager.play('heal');
                let healAmount = Math.floor(attacker.atk * (skill.val || 1) * atkMod);
                ally.currentHp = Math.min(ally.maxHp, ally.currentHp + healAmount);
                showHealText(allyEl, healAmount);
                if (skill.status && (skill.status.type === 'def_up' || skill.status.type === 'atk_up' || skill.status.type === 'regen')) {
                     applySkillStatus(ally); 
                }
            } else if (skill.type === 'aoe') {
                SoundManager.play('heavy_attack');
                const targetList = attacker.isPlayer ? battleState.enemies : battleState.players;
                targetList.forEach((enemy, idx) => {
                    if (enemy.currentHp > 0) {
                         const eElId = attacker.isPlayer ? `enemy-el-${idx}` : `player-el-${idx}`;
                         const eEl = document.getElementById(eElId);
                         if(eEl) createBattleEffect(eEl, 'magic');
                         const result = calculateDamage(attacker, enemy, skill.val || 1);
                         if (!result.isDodge) {
                             enemy.currentHp -= result.damage;
                             showDamageText(eEl, result);
                             applySkillStatus(enemy);
                         } else {
                             showDamageText(eEl, result);
                         }
                    }
                });
            } else {
                SoundManager.play('attack');
                // Single Target
                // Note: For players, targetIndex is explicitly passed. For enemies, logic determines target.
                let finalTarget = null;
                if(attacker.isPlayer) {
                    finalTarget = battleState.enemies[targetIndex];
                } else {
                    finalTarget = battleState.players[targetIndex]; // Enemy AI logic passed player index
                }

                if(finalTarget) {
                    const tIdx = attacker.isPlayer ? battleState.enemies.indexOf(finalTarget) : battleState.players.indexOf(finalTarget);
                    const tElId = attacker.isPlayer ? `enemy-el-${tIdx}` : `player-el-${tIdx}`;
                    const targetEl = document.getElementById(tElId);

                    if(targetEl) createBattleEffect(targetEl, 'slash');
                    const result = calculateDamage(attacker, finalTarget, skill.val || 1);

                    if (!result.isDodge) {
                        finalTarget.currentHp -= result.damage;
                        showDamageText(targetEl, result);
                        applySkillStatus(finalTarget);
                        if (skill.type === 'lifesteal') {
                            let heal = Math.floor(result.damage * 0.5);
                            attacker.currentHp = Math.min(attacker.maxHp, attacker.currentHp + heal);
                            showHealText(attackerEl, heal);
                        }
                    } else {
                        showDamageText(targetEl, result);
                    }
                }
            }
        }
        
        function createBattleEffect(targetEl, type) {
            if(!targetEl) return;
            const rect = targetEl.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            if (type === 'slash') {
                const slash = document.createElement('div');
                slash.className = 'vfx-slash';
                slash.style.left = `${rect.left + rect.width/2 - 50}px`;
                slash.style.top = `${rect.top + rect.height/2 - 50}px`;
                document.body.appendChild(slash);
                setTimeout(() => slash.remove(), 400);
            } 
            else if (type === 'magic') {
                const burst = document.createElement('div');
                burst.className = 'vfx-burst-ring';
                burst.style.borderColor = '#805ad5';
                burst.style.left = `${rect.left + rect.width/2 - 40}px`;
                burst.style.top = `${rect.top + rect.height/2 - 40}px`;
                document.body.appendChild(burst);
                setTimeout(() => burst.remove(), 600);

                for(let i=0; i<8; i++) {
                    const p = document.createElement('div');
                    p.className = 'vfx-particle';
                    p.style.backgroundColor = '#d6bcfa';
                    p.style.left = `${centerX}px`;
                    p.style.top = `${centerY}px`;
                    const angle = (Math.PI * 2 * i) / 8;
                    const dist = 60;
                    p.style.setProperty('--tx', `${Math.cos(angle) * dist}px`);
                    p.style.setProperty('--ty', `${Math.sin(angle) * dist}px`);
                    document.body.appendChild(p);
                    setTimeout(() => p.remove(), 600);
                }
            } 
            else if (type === 'heal') {
                const burst = document.createElement('div');
                burst.className = 'vfx-burst-ring';
                burst.style.borderColor = '#48bb78';
                burst.style.left = `${rect.left + rect.width/2 - 40}px`;
                burst.style.top = `${rect.top + rect.height/2 - 40}px`;
                document.body.appendChild(burst);
                setTimeout(() => burst.remove(), 600);
                for(let i=0; i<6; i++) {
                    const p = document.createElement('div');
                    p.className = 'vfx-particle';
                    p.style.backgroundColor = '#68d391';
                    p.style.left = `${centerX}px`;
                    p.style.top = `${centerY}px`;
                    p.style.setProperty('--tx', `0px`);
                    p.style.setProperty('--ty', `-60px`);
                    p.style.animationDelay = `${i * 0.1}s`;
                    document.body.appendChild(p);
                    setTimeout(() => p.remove(), 1000);
                }
            }
        }
        function playUltimateCutin(attacker, skill, callback) {
            SoundManager.play('ultimate');
            const cutin = document.getElementById('ultimate-cutin');
            const bg = document.getElementById('cutin-bg');
            const cutinImg = document.getElementById('cutin-img');
            const textDiv = document.getElementById('cutin-text');
            const classIconDiv = document.getElementById('cutin-class-icon');
            if(cutinImg) cutinImg.src = getCharImage(attacker);
            if(textDiv) textDiv.innerText = skill.name;
            if(classIconDiv) classIconDiv.innerText = attacker.icon;
            if(cutin) cutin.classList.remove('hidden');
            if(bg) bg.classList.add('cutin-bg-animate');
            if(textDiv) textDiv.classList.add('cutin-text-animate');
            if(classIconDiv) classIconDiv.classList.add('cutin-icon-animate');
            if(cutinImg) {
                cutinImg.classList.remove('cutin-char-animate');
                void cutinImg.offsetWidth;
                cutinImg.classList.add('cutin-char-animate');
            }
            setTimeout(() => {
                if(cutin) cutin.classList.add('hidden'); 
                if(bg) bg.classList.remove('cutin-bg-animate');
                if(cutinImg) cutinImg.classList.remove('cutin-char-animate'); 
                if(textDiv) textDiv.classList.remove('cutin-text-animate');
                if(classIconDiv) classIconDiv.classList.remove('cutin-icon-animate'); 
                callback();
            }, 900); 
        }
        function showDamageText(targetEl, result) { 
            if(!targetEl) return; 
            const rect = targetEl.getBoundingClientRect(); 
            const text = document.createElement('div'); 
            text.className = 'damage-text'; 
            if (typeof result === 'number') {
                text.innerText = result;
            } else {
                if (result.isDodge) {
                    text.innerText = "Miss";
                    text.style.color = "#a0aec0"; 
                } else {
                    text.innerText = result.damage;
                    if (result.isCrit) {
                        text.innerText = "Crit " + result.damage + "!";
                        text.style.color = "#ecc94b"; 
                        text.style.fontSize = "2.5rem";
                    }
                    if (result.eleMod > 1.0) {
                         text.innerText += " (Weak!)";
                         text.style.color = "#f56565"; 
                    } else if (result.eleMod < 1.0) {
                         text.innerText += " (Resist)";
                         text.style.color = "#63b3ed"; 
                    }
                }
            }
            document.body.appendChild(text); 
            text.style.left = `${rect.left + rect.width / 2}px`; 
            text.style.top = `${rect.top - 20}px`; 
            setTimeout(() => text.remove(), 1000); 
        }
        function showHealText(targetEl, amount) { if(!targetEl) return; const rect = targetEl.getBoundingClientRect(); const text = document.createElement('div'); text.className = 'heal-text'; text.innerText = `+${amount}`; document.body.appendChild(text); text.style.left = `${rect.left + rect.width / 2}px`; text.style.top = `${rect.top - 20}px`; setTimeout(() => text.remove(), 1000); }
        function showSkillText(targetEl, name) { if(!targetEl) return; const rect = targetEl.getBoundingClientRect(); const text = document.createElement('div'); text.className = 'skill-text'; text.innerText = name; document.body.appendChild(text); text.style.left = `${rect.left + rect.width / 2}px`; text.style.top = `${rect.top - 60}px`; setTimeout(() => text.remove(), 1500); }
        function toggleTurnIndicator(text) { 
            const el = document.getElementById('turn-indicator'); 
            const textSpan = document.getElementById('turn-text'); 
            if(textSpan) textSpan.innerText = text; 
            if(el) {
                el.classList.remove('hidden'); 
                setTimeout(() => el.classList.add('hidden'), 1500); 
            }
        }
    </script>
</body>
</html>
